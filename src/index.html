<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mac åƒ¹æ ¼æ¯”è¼ƒå·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang TC', 'Hiragino Sans GB', sans-serif;
            background-color: #F2F2F7; /* Blueprint: èƒŒæ™¯è‰² */
            color: #1D1D1F; /* Blueprint: æ–‡å­—è‰² */
            line-height: 1.5;
        }

        .header {
            background: #007AFF; /* Blueprint: ä¸»è‰² */
            color: white;
            padding: 2rem 0;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .input-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #1D1D1F;
        }

        .url-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #E5E5EA;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .url-input:focus {
            outline: none;
            border-color: #007AFF; /* Blueprint: ä¸»è‰² */
        }

        .btn {
            background: #007AFF; /* Blueprint: ä¸»è‰² */
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #005bb5; /* Darker shade of Apple Blue */
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #34C759; /* Blueprint: æ¬¡è¦è‰² */
        }

        .btn-secondary:hover {
            background: #28a745; /* Darker shade of System Green */
        }

        .filters-section {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .filters-panel {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            height: fit-content;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        .filter-group {
            margin-bottom: 1.5rem;
        }

        .filter-group h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.8rem;
            color: #1D1D1F;
            border-bottom: 2px solid #F2F2F7;
            padding-bottom: 0.5rem;
        }

        .filter-options {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #007AFF;
        }

        .filter-option label {
            font-size: 0.9rem;
            color: #666;
            cursor: pointer;
        }

        .price-range {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .price-input {
            width: 100px;
            padding: 8px 12px;
            border: 1px solid #E5E5EA;
            border-radius: 6px;
            font-size: 14px;
        }

        .results-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        .results-header {
            display: flex;
            justify-content: space-between; /* Corrected from 'between' */
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #F2F2F7;
        }

        .view-toggle {
            display: flex;
            gap: 0.5rem;
        }

        .view-btn {
            padding: 8px 16px;
            border: 1px solid #E5E5EA;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .view-btn.active {
            background: #007AFF; /* Blueprint: ä¸»è‰² */
            color: white;
            border-color: #007AFF; /* Blueprint: ä¸»è‰² */
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .product-card {
            border: 1px solid #E5E5EA;
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            background: white;
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .product-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1D1D1F;
        }

        .condition-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .condition-new { background: #30D158; color: white; } /* Blueprint: æˆåŠŸè‰² */
        .condition-refurbished { background: #FF9500; color: white; } /* Blueprint: å¼·èª¿è‰² */
        .condition-used-a { background: #34C759; color: white; } /* Blueprint: æ¬¡è¦è‰² (for good condition used) */
        .condition-used-b { background: #FFCC00; color: #1D1D1F; } /* Yellow for B grade */
        .condition-used-c { background: #FF6B35; color: white; } /* Orange-Red for C grade */
        .condition-student { background: #007AFF; color: white; } /* Blueprint: ä¸»è‰² */

        .product-specs {
            margin-bottom: 1rem;
        }

        .spec-item {
            display: flex;
            justify-content: space-between;
            padding: 0.3rem 0;
            font-size: 0.9rem;
            border-bottom: 1px solid #F2F2F7;
        }

        .spec-label {
            color: #666;
            font-weight: 500;
        }

        .spec-value {
            color: #1D1D1F;
            font-weight: 600;
        }

        .product-price {
            text-align: center;
            margin-bottom: 1rem;
        }

        .price-amount {
            font-size: 1.8rem;
            font-weight: 700;
            color: #007AFF; /* Blueprint: ä¸»è‰² */
        }

        .price-currency {
            font-size: 1rem;
            color: #666;
            margin-left: 0.2rem;
        }

        .product-source {
            text-align: center;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 1rem;
        }

        .product-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            flex: 1;
            padding: 8px 16px;
            font-size: 0.9rem;
            border-radius: 6px;
        }

        .comparison-section {
            margin-top: 2rem;
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        .chart-container {
            margin-top: 1.5rem;
            height: 400px;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #F2F2F7;
            border-top: 4px solid #007AFF; /* Blueprint: ä¸»è‰² */
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: #F8F9FA;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #007AFF; /* Blueprint: ä¸»è‰² */
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.2rem;
        }

        .analysis-tab {
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: #666;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .analysis-tab.active {
            color: #007AFF; /* Blueprint: ä¸»è‰² */
            border-bottom-color: #007AFF; /* Blueprint: ä¸»è‰² */
        }

        .analysis-tab:hover {
            color: #007AFF; /* Blueprint: ä¸»è‰² */
            background: rgba(0, 122, 255, 0.05);
        }

        .analysis-panel {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .price-difference-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            background: white;
            border-radius: 6px;
            border-left: 4px solid #007AFF; /* Blueprint: ä¸»è‰² */
        }

        .price-difference-positive {
            border-left-color: #30D158; /* Blueprint: æˆåŠŸè‰² */
        }

        .price-difference-negative {
            border-left-color: #FF3B30; /* Red for negative difference */
        }

        .specs-comparison-grid {
            display: grid;
            grid-template-columns: 200px repeat(auto-fill, minmax(150px, 1fr));
            gap: 1px;
            background: #E5E5EA;
            border-radius: 8px;
            overflow: hidden;
        }

        .specs-cell {
            background: white;
            padding: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.9rem;
        }

        .specs-header {
            background: #F8F9FA;
            font-weight: 600;
            color: #1D1D1F;
        }

        .specs-different {
            background: #FFF3CD; /* Light yellow for highlighting differences */
            border-left: 3px solid #FF9500; /* Blueprint: å¼·èª¿è‰² */
        }

        .prompt-section {
            background: white;
            border: 1px solid #E5E5EA;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .performance-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        
        /* Database Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #F2F2F7;
            margin: 10% auto;
            padding: 2rem;
            border-radius: 12px;
            width: 80%;
            max-width: 800px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #E5E5EA;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }

        .modal-header h2 {
            color: #1D1D1F;
            font-size: 1.8rem;
        }

        .close-btn {
            color: #666;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close-btn:hover {
            color: #1D1D1F;
        }

        .db-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .db-stat-item {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #E5E5EA;
        }

        .db-stat-item strong {
            display: block;
            font-size: 1.5rem;
            color: #007AFF; /* Blueprint: ä¸»è‰² */
            margin-bottom: 0.3rem;
        }

        .db-stat-item span {
            font-size: 0.9rem;
            color: #666;
        }

        .db-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        #databaseList {
            max-height: 400px;
            overflow-y: auto;
            background: #F8F9FA;
            padding: 1rem;
            border-radius: 8px;
        }


        @media (max-width: 768px) {
            .filters-section {
                grid-template-columns: 1fr;
            }
            
            .products-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .container {
                padding: 1rem;
            }

            .analysis-panel {
                grid-template-columns: 1fr !important;
            }

            .specs-comparison-grid {
                grid-template-columns: 150px repeat(auto-fill, minmax(120px, 1fr));
            }
            .modal-content {
                width: 95%;
                margin: 5% auto;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>Mac åƒ¹æ ¼æ¯”è¼ƒå·¥å…·</h1>
        <p>ä¸€ç«™å¼ Mac ç”¢å“åƒ¹æ ¼æ¯”è¼ƒå¹³å° - æ•´åˆå¤šå€‹é›»å•†ç¶²ç«™æ•¸æ“š</p>
    </header>

    <div class="container">
        <!-- æ•¸æ“šè¼¸å…¥å€ -->
        <section class="input-section">
            <h2 style="margin-bottom: 1rem; color: #1D1D1F;">æ–°å¢åƒ¹æ ¼ä¾†æº</h2>
            
            <!-- URL è¼¸å…¥ -->
            <div class="input-group">
                <label for="websiteUrl">ğŸŒ ç¶²ç«™ URL</label>
                <input type="url" id="websiteUrl" class="url-input" placeholder="è«‹è¼¸å…¥å•†å“é é¢ç¶²å€ (å¦‚ï¼šApple Storeã€PChomeã€momo ç­‰)">
            </div>

            <!-- å‰ªè²¼ç°¿è‡ªå‹•æª¢æ¸¬ -->
            <div class="input-group">
                <label>ğŸ“‹ å‰ªè²¼ç°¿è‡ªå‹•æª¢æ¸¬</label>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <button class="btn" onclick="toggleClipboardMonitor()" id="clipboardBtn" style="background: #5856D6;">
                        <span>ğŸ‘ï¸</span> å•Ÿå‹•å‰ªè²¼ç°¿ç›£æ§
                    </button>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div id="clipboardStatus" style="width: 12px; height: 12px; border-radius: 50%; background: #FF3B30;"></div>
                        <span id="clipboardText" style="font-size: 0.9rem; color: #666;">ç›£æ§å·²åœæ­¢</span>
                    </div>
                </div>
                <div id="clipboardUrls" style="margin-top: 0.5rem; font-size: 0.9rem; color: #007AFF; display: none;">
                    <strong>æª¢æ¸¬åˆ°çš„ç¶²å€ï¼š</strong>
                    <div id="urlList" style="margin-top: 0.3rem;"></div>
                </div>
            </div>

            <!-- æ–‡ä»¶ä¸Šå‚³ -->
            <div class="input-group">
                <label for="fileUpload">ğŸ“ ä¸Šå‚³åƒ¹æ ¼æ•¸æ“šæ–‡ä»¶</label>
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <input type="file" id="fileUpload" accept=".html,.md,.txt,.csv" multiple style="display: none;" onchange="handleFileUpload(event)">
                    <button class="btn" onclick="document.getElementById('fileUpload').click()" style="background: #34C759;">
                        <span>ğŸ“</span> é¸æ“‡æ–‡ä»¶
                    </button>
                    <button class="btn" onclick="handlePasteContent()" style="background: #FF9500;">
                        <span>ğŸ“‹</span> è²¼ä¸Šå…§å®¹
                    </button>
                    <span id="fileName" style="color: #666; font-size: 0.9rem;">æ”¯æ´å¤šæª”æ¡ˆä¸Šå‚³ï¼šHTMLã€Markdownã€TXTã€CSV</span>
                </div>
            </div>

            <!-- æ‰¹é‡ URL è¼¸å…¥ -->
            <div class="input-group">
                <label for="bulkUrls">ğŸ“‹ æ‰¹é‡ URL è¼¸å…¥</label>
                <textarea id="bulkUrls" class="url-input" style="height: 100px; resize: vertical;" placeholder="è«‹è¼¸å…¥å¤šå€‹ç¶²å€ï¼Œæ¯è¡Œä¸€å€‹ï¼š
https://example1.com/product1
https://example2.com/product2
..."></textarea>
            </div>

            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <button class="btn" onclick="addUrlSource()">
                    <span>ğŸ”</span> æŠ“å–å–®ä¸€ç¶²å€
                </button>
                <button class="btn" onclick="processBulkUrls()" style="background: #5856D6;">
                    <span>âš¡</span> æ‰¹é‡è™•ç†ç¶²å€
                </button>
                <button class="btn btn-secondary" onclick="loadSampleData()">
                    <span>ğŸ“Š</span> è¼‰å…¥ç¯„ä¾‹è³‡æ–™
                </button>
                <button class="btn" onclick="exportData()" style="background: #FF9500;">
                    <span>ğŸ“¤</span> åŒ¯å‡ºæ¯”è¼ƒçµæœ
                </button>
                <button class="btn" onclick="clearAllData()" style="background: #FF3B30;">
                    <span>ğŸ—‘ï¸</span> æ¸…ç©ºæ•¸æ“š
                </button>
                <button class="btn" onclick="showDatabaseManager()" style="background: #AF52DE;">
                    <span>ğŸ’¾</span> æ•¸æ“šåº«ç®¡ç†
                </button>
            </div>

            <!-- è§£æèªªæ˜ -->
            <div style="margin-top: 1rem; padding: 1rem; background: linear-gradient(135deg, #E3F2FD, #F3E5F5); border-radius: 8px; border-left: 4px solid #007AFF;">
                <h4 style="margin-bottom: 0.5rem; color: #1D1D1F;">ğŸ§  æ™ºèƒ½è§£æåŠŸèƒ½</h4>
                <div style="font-size: 0.9rem; color: #666; line-height: 1.6;">
                    <p><strong>æ”¯æ´æ ¼å¼ï¼š</strong></p>
                    <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                        <li><strong>HTML</strong> - è‡ªå‹•æ¸…ç†æ¨™ç±¤ï¼Œæå–å•†å“ä¿¡æ¯</li>
                        <li><strong>Markdown</strong> - è§£æè¡¨æ ¼å’Œåˆ—è¡¨ä¸­çš„ç”¢å“æ•¸æ“š</li>
                        <li><strong>CSV</strong> - æ™ºèƒ½è­˜åˆ¥æ¬„ä½ï¼Œè‡ªå‹•åŒ¹é…åƒ¹æ ¼è¦æ ¼</li>
                        <li><strong>TXT</strong> - æ–‡æœ¬åˆ†æï¼Œæå–åƒ¹æ ¼å’Œè¦æ ¼ä¿¡æ¯</li>
                        <li><strong>å‰ªè²¼ç°¿</strong> - è‡ªå‹•æª¢æ¸¬è¤‡è£½çš„ç¶²å€æˆ–å…§å®¹</li>
                    </ul>
                    <p><strong>æ™ºèƒ½è­˜åˆ¥ï¼š</strong>ç”¢å“åç¨±ã€åƒ¹æ ¼ (NT$)ã€æ™¶ç‰‡/CPU/GPUã€RAMã€SSDã€è¢å¹•ã€ç‹€æ…‹</p>
                    <p><strong>è‡ªå‹•è£œè¶³ï¼š</strong>è¦æ ¼ä¸å®Œæ•´æ™‚è‡ªå‹•æœå°‹ç¶²è·¯è£œå……ç”¢å“è³‡è¨Š</p>
                    <p><strong>æ•¸æ“šåº«ï¼š</strong>æ‰€æœ‰ç”¢å“æ•¸æ“šæŒä¹…åŒ–ä¿å­˜ï¼Œæ”¯æ´æ‰¹é‡ç®¡ç†èˆ‡å»é‡</p>
                </div>
            </div>

            <!-- è§£æç‹€æ…‹é¡¯ç¤º -->
            <div id="parseStatus" style="margin-top: 1rem; padding: 1rem; background: #F8F9FA; border-radius: 8px; display: none;">
                <h4 style="margin-bottom: 0.5rem; color: #1D1D1F;">ğŸ“ˆ è§£æé€²åº¦</h4>
                <div id="parseProgress" style="background: #E5E5EA; height: 8px; border-radius: 4px; overflow: hidden;">
                    <div id="progressBar" style="background: #007AFF; height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                </div>
                <div id="parseDetails" style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;"></div>
            </div>
        </section>

        <!-- çµ±è¨ˆæ¦‚è¦½ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalProducts">0</div>
                <div class="stat-label">å•†å“ç¸½æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="averagePrice">$0</div>
                <div class="stat-label">å¹³å‡åƒ¹æ ¼</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="priceRange">$0</div>
                <div class="stat-label">åƒ¹å·®ç¯„åœ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="sourcesCount">0</div>
                <div class="stat-label">åƒ¹æ ¼ä¾†æº</div>
            </div>
        </div>

        <!-- ç¯©é¸å™¨èˆ‡çµæœå€ -->
        <div class="filters-section">
            <!-- ç¯©é¸é¢æ¿ -->
            <aside class="filters-panel">
                <h2 style="margin-bottom: 1rem; color: #1D1D1F;">ç¯©é¸æ¢ä»¶</h2>
                
                <div class="filter-group">
                    <h3>ğŸ“± ç”¢å“ç³»åˆ—</h3>
                    <div class="filter-options">
                        <div class="filter-option">
                            <input type="checkbox" id="macbook-air" checked>
                            <label for="macbook-air">MacBook Air</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="macbook-pro" checked>
                            <label for="macbook-pro">MacBook Pro</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="imac" checked>
                            <label for="imac">iMac</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="mac-mini" checked>
                            <label for="mac-mini">Mac mini</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="mac-studio" checked>
                            <label for="mac-studio">Mac Studio</label>
                        </div>
                    </div>
                </div>

                <div class="filter-group">
                    <h3>ğŸ’¾ è¨˜æ†¶é«”</h3>
                    <div class="filter-options">
                        <div class="filter-option">
                            <input type="checkbox" id="ram-8gb" checked>
                            <label for="ram-8gb">8GB</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="ram-16gb" checked>
                            <label for="ram-16gb">16GB</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="ram-32gb" checked>
                            <label for="ram-32gb">32GB</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="ram-64gb" checked>
                            <label for="ram-64gb">64GB+</label>
                        </div>
                    </div>
                </div>

                <div class="filter-group">
                    <h3>ğŸ’¿ å„²å­˜å®¹é‡</h3>
                    <div class="filter-options">
                        <div class="filter-option">
                            <input type="checkbox" id="storage-256gb" checked>
                            <label for="storage-256gb">256GB</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="storage-512gb" checked>
                            <label for="storage-512gb">512GB</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="storage-1tb" checked>
                            <label for="storage-1tb">1TB</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="storage-2tb" checked>
                            <label for="storage-2tb">2TB+</label>
                        </div>
                    </div>
                </div>

                <div class="filter-group">
                    <h3>ğŸ”§ å•†å“ç‹€æ³</h3>
                    <div class="filter-options">
                        <div class="filter-option">
                            <input type="checkbox" id="condition-new" checked>
                            <label for="condition-new">å…¨æ–°</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="condition-refurbished" checked>
                            <label for="condition-refurbished">å®˜æ–¹æ•´æ–°å“</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="condition-used-a" checked>
                            <label for="condition-used-a">äºŒæ‰‹ A ç´š</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="condition-used-b" checked>
                            <label for="condition-used-b">äºŒæ‰‹ B ç´š</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="condition-used-c">
                            <label for="condition-used-c">äºŒæ‰‹ C ç´š</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="condition-student" checked>
                            <label for="condition-student">æ•™è‚²åƒ¹</label>
                        </div>
                    </div>
                </div>

                <div class="filter-group">
                    <h3>ğŸ’° åƒ¹æ ¼ç¯„åœ (TWD)</h3>
                    <div class="price-range">
                        <input type="number" class="price-input" id="minPrice" placeholder="æœ€ä½åƒ¹" min="0">
                        <span>-</span>
                        <input type="number" class="price-input" id="maxPrice" placeholder="æœ€é«˜åƒ¹" min="0">
                    </div>
                </div>

                <button class="btn" onclick="applyFilters()" style="width: 100%; margin-top: 1rem;">
                    å¥—ç”¨ç¯©é¸
                </button>
            </aside>

            <!-- çµæœé¡¯ç¤ºå€ -->
            <main class="results-section">
                <div class="results-header">
                    <h2 style="color: #1D1D1F;">æ¯”è¼ƒçµæœ</h2>
                    <div class="view-toggle">
                        <button class="view-btn active" onclick="switchView('grid')">å¡ç‰‡æª¢è¦–</button>
                        <button class="view-btn" onclick="switchView('table')">è¡¨æ ¼æª¢è¦–</button>
                        <button class="view-btn" onclick="switchView('chart')">åœ–è¡¨æª¢è¦–</button>
                    </div>
                </div>

                <div id="loading" class="loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p>æ­£åœ¨æŠ“å–å•†å“è³‡æ–™...</p>
                </div>

                <div id="products-container" class="products-grid">
                    <!-- å•†å“å¡ç‰‡å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </main>
        </div>

        <!-- åƒ¹æ ¼è¶¨å‹¢åœ–è¡¨å€ -->
        <section class="comparison-section">
            <h2 style="margin-bottom: 1rem; color: #1D1D1F;">ğŸ“ˆ åƒ¹æ ¼åˆ†æèˆ‡è¦æ ¼å·®ç•°</h2>
            
            <!-- åˆ†æé¸é …å¡ -->
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 2px solid #F2F2F7;">
                <button class="analysis-tab active" onclick="switchAnalysisTab('price')" data-tab="price">
                    ğŸ’° åƒ¹å·®åˆ†æ
                </button>
                <button class="analysis-tab" onclick="switchAnalysisTab('specs')" data-tab="specs">
                    ğŸ”§ è¦æ ¼å·®ç•°
                </button>
                <button class="analysis-tab" onclick="switchAnalysisTab('trends')" data-tab="trends">
                    ğŸ“Š åƒ¹æ ¼è¶¨å‹¢
                </button>
                <button class="analysis-tab" onclick="switchAnalysisTab('ai')" data-tab="ai">
                    ğŸ¤– AI åˆ†æ
                </button>
            </div>

            <!-- åƒ¹å·®åˆ†æé¢æ¿ -->
            <div id="priceAnalysisPanel" class="analysis-panel">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div>
                        <h3 style="margin-bottom: 1rem;">ğŸ’¸ åƒ¹å·®çµ±è¨ˆ</h3>
                        <div id="priceDifferenceStats" style="background: #F8F9FA; padding: 1rem; border-radius: 8px;">
                            <!-- åƒ¹å·®çµ±è¨ˆå°‡åœ¨é€™è£¡é¡¯ç¤º -->
                        </div>
                    </div>
                    <div>
                        <h3 style="margin-bottom: 1rem;">ğŸ† æœ€ä½³åƒ¹æ ¼æ¨è–¦</h3>
                        <div id="bestPriceRecommendations" style="background: #F8F9FA; padding: 1rem; border-radius: 8px;">
                            <!-- åƒ¹æ ¼æ¨è–¦å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                        </div>
                    </div>
                </div>
                <div class="chart-container" style="margin-top: 1.5rem;">
                    <canvas id="priceComparisonChart"></canvas>
                </div>
            </div>

            <!-- è¦æ ¼å·®ç•°é¢æ¿ -->
            <div id="specsAnalysisPanel" class="analysis-panel" style="display: none;">
                <div style="margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem;">âš™ï¸ è¦æ ¼é…ç½®åˆ†æ</h3>
                    <div id="specsComparisonTable" style="background: #F8F9FA; padding: 1rem; border-radius: 8px;">
                        <!-- è¦æ ¼æ¯”è¼ƒè¡¨æ ¼å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="chart-container">
                        <canvas id="specsDistributionChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="performanceScoreChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- åƒ¹æ ¼è¶¨å‹¢é¢æ¿ -->
            <div id="trendsAnalysisPanel" class="analysis-panel" style="display: none;">
                <div style="margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem;">ğŸ“ˆ åƒ¹æ ¼è¶¨å‹¢é æ¸¬</h3>
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                        <button class="btn" onclick="generateTrendForecast()" style="background: #5856D6;">
                            ğŸ”® ç”Ÿæˆè¶¨å‹¢é æ¸¬
                        </button>
                        <button class="btn" onclick="analyzePricePattern()" style="background: #AF52DE;">
                            ğŸ“Š åˆ†æåƒ¹æ ¼æ¨¡å¼
                        </button>
                         <button class="btn" onclick="showPriceDistribution()" style="background: #34C759;">
                            ğŸ“ˆ åƒ¹æ ¼åˆ†å¸ƒåœ–
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="trendAnalysisChart"></canvas>
                </div>
                 <div id="pricePatternResults" style="margin-top: 1.5rem; display: none;">
                    <!-- åƒ¹æ ¼æ¨¡å¼åˆ†æçµæœ -->
                </div>
            </div>

            <!-- AI åˆ†æé¢æ¿ -->
            <div id="aiAnalysisPanel" class="analysis-panel" style="display: none;">
                <div style="margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem;">ğŸ¤– AI åˆ†æ Prompt ç”Ÿæˆå™¨</h3>
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                        <button class="btn" onclick="generatePriceAnalysisPrompt()" style="background: #007AFF;">
                            ğŸ’° åƒ¹æ ¼åˆ†æ Prompt
                        </button>
                        <button class="btn" onclick="generateSpecsAnalysisPrompt()" style="background: #34C759;">
                            ğŸ”§ è¦æ ¼åˆ†æ Prompt
                        </button>
                        <button class="btn" onclick="generatePurchaseAdvicePrompt()" style="background: #FF9500;">
                            ğŸ›’ è³¼è²·å»ºè­° Prompt
                        </button>
                        <button class="btn" onclick="generateCompetitiveAnalysisPrompt()" style="background: #5856D6;">
                            ğŸ† ç«¶çˆ­åˆ†æ Prompt
                        </button>
                    </div>
                </div>
                <div id="aiPromptOutput" style="background: #F8F9FA; padding: 1.5rem; border-radius: 8px; min-height: 300px; border: 2px dashed #E5E5EA;">
                    <p style="text-align: center; color: #666; margin: 0;">é¸æ“‡ä¸Šæ–¹æŒ‰éˆ•ç”Ÿæˆç›¸æ‡‰çš„ AI åˆ†æ Prompt</p>
                </div>
                <div style="margin-top: 1rem; text-align: center;">
                    <button class="btn" onclick="copyPromptToClipboard()" style="background: #30D158;" disabled id="copyPromptBtn">
                        ğŸ“‹ è¤‡è£½ Prompt åˆ°å‰ªè²¼ç°¿
                    </button>
                </div>
            </div>
        </section>

        <!-- Database Management Modal -->
        <div id="databaseModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>ğŸ’¾ æ•¸æ“šåº«ç®¡ç†</h2>
                    <span class="close-btn" onclick="closeDatabaseManager()">&times;</span>
                </div>
                <div class="db-stats">
                    <div class="db-stat-item">
                        <strong id="dbTotalCount">0</strong>
                        <span>ç¸½ç”¢å“æ•¸</span>
                    </div>
                    <div class="db-stat-item">
                        <strong id="dbSourceCount">0</strong>
                        <span>ä¾†æºæ•¸é‡</span>
                    </div>
                    <div class="db-stat-item">
                        <strong id="dbLastUpdate">ç„¡</strong>
                        <span>æœ€å¾Œæ›´æ–°</span>
                    </div>
                </div>
                <div class="db-actions">
                    <button class="btn" onclick="removeDuplicates()" style="background: #FF9500;">âœ¨ å»é™¤é‡è¤‡</button> <!-- Blueprint: å¼·èª¿è‰² -->
                    <button class="btn" onclick="refreshAllData()" style="background: #34C759;">ğŸ”„ é‡æ–°æ•´ç†</button> <!-- Blueprint: æ¬¡è¦è‰² -->
                    <button class="btn" onclick="exportDatabase()" style="background: #007AFF;">ğŸ“¤ åŒ¯å‡ºæ•¸æ“š</button> <!-- Blueprint: ä¸»è‰² -->
                    <button class="btn" onclick="importDatabase()" style="background: #5856D6;">ğŸ“¥ åŒ¯å…¥æ•¸æ“š</button> <!-- Purple for distinct action -->
                    <button class="btn" onclick="clearDatabase()" style="background: #FF3B30;">ğŸ—‘ï¸ æ¸…ç©ºæ•¸æ“šåº«</button> <!-- Red for destructive action -->
                </div>
                <div id="databaseList">
                    <!-- Database items will be listed here -->
                </div>
            </div>
        </div>

    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let allProducts = [];
        let filteredProducts = [];
        let currentView = 'grid';
        // let priceChart = null; // Removed as it's defined locally in renderChart
        let parseResults = [];
        // let currentParseIndex = 0; // Seems unused
        let productDatabase = new Map(); // æœ¬åœ°æ•¸æ“šåº«
        let clipboardUrls = new Set(); // å‰ªè²¼ç°¿ URL è¿½è¹¤
        let lastClipboardCheck = '';
        let currentPrompt = ''; // For AI prompts

        // === æ•¸æ“šåº«ç®¡ç†é¢æ¿åŠŸèƒ½ ===
        function showDatabaseManager() {
            updateDatabaseStats();
            document.getElementById('databaseModal').style.display = 'block';
            loadDatabaseList();
        }

        function closeDatabaseManager() {
            document.getElementById('databaseModal').style.display = 'none';
        }

        function updateDatabaseStats() {
            const totalCount = productDatabase.size;
            const sources = new Set(Array.from(productDatabase.values()).map(p => p.source)).size;
            const lastUpdate = totalCount > 0 ? 
                new Date(Math.max(...Array.from(productDatabase.values()).map(p => new Date(p.lastUpdated)))).toLocaleString('zh-TW') : 
                'ç„¡';

            document.getElementById('dbTotalCount').textContent = totalCount;
            document.getElementById('dbSourceCount').textContent = sources;
            document.getElementById('dbLastUpdate').textContent = lastUpdate;
        }

        function loadDatabaseList() {
            const products = Array.from(productDatabase.values());
            const listHtml = products.map(product => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; margin-bottom: 0.5rem; background: white; border-radius: 6px; border: 1px solid #E5E5EA;">
                    <div>
                        <strong>${product.name}</strong><br>
                        <small style="color: #666;">${product.price.toLocaleString()} - ${product.source}</small>
                    </div>
                    <button onclick="removeFromDatabase('${product.dbKey}')" style="background: #FF3B30; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">
                        åˆªé™¤
                    </button>
                </div>
            `).join('');

            document.getElementById('databaseList').innerHTML = listHtml || '<p style="text-align: center; color: #666;">æ•¸æ“šåº«ç‚ºç©º</p>';
        }
        
        function readFileContent(file) { // Added from external snippets
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsText(file, 'UTF-8');
            });
        }

        function removeFromDatabase(dbKey) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ç”¢å“å—ï¼Ÿ')) {
                productDatabase.delete(dbKey);
                persistDatabase();
                syncDatabaseToProducts();
                loadDatabaseList();
                updateDatabaseStats();
                applyFilters(); // Ensure UI updates after removal
            }
        }

        function removeDuplicates() {
            const seen = new Set();
            const toRemove = [];
            const tempProducts = Array.from(productDatabase.values()); // Create a temporary array

            for (const product of tempProducts) { // Iterate over the temporary array
                const signature = `${product.name}_${product.price}_${product.memory}_${product.storage}`;
                if (seen.has(signature)) {
                    toRemove.push(product.dbKey);
                } else {
                    seen.add(signature);
                }
            }
        
            toRemove.forEach(key => productDatabase.delete(key));
            
            if (toRemove.length > 0) {
                persistDatabase();
                syncDatabaseToProducts();
                loadDatabaseList();
                updateDatabaseStats();
                applyFilters();
                alert(`å·²ç§»é™¤ ${toRemove.length} å€‹é‡è¤‡ç”¢å“ã€‚`);
            } else {
                alert('æ²’æœ‰ç™¼ç¾é‡è¤‡ç”¢å“ã€‚');
            }
        }

        function refreshAllData() {
            showParseStatus('æ­£åœ¨é‡æ–°æ•´ç†æ‰€æœ‰ç”¢å“æ•¸æ“š...');
            
            setTimeout(() => {
                Array.from(productDatabase.values()).forEach(product => {
                    product.lastUpdated = new Date();
                    const priceVariation = (Math.random() - 0.5) * 0.02; // Â±1%
                    product.price = Math.round(product.price * (1 + priceVariation));
                });
                
                persistDatabase();
                syncDatabaseToProducts();
                loadDatabaseList();
                updateDatabaseStats();
                applyFilters();
                hideParseStatus();
                alert('æ‰€æœ‰ç”¢å“æ•¸æ“šå·²é‡æ–°æ•´ç†å®Œæˆã€‚');
            }, 2000);
        }

        function clearDatabase() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ•´å€‹æ•¸æ“šåº«å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ¢å¾©ã€‚')) {
                productDatabase.clear();
                localStorage.removeItem('macPriceDatabase');
                allProducts = [];
                filteredProducts = [];
                loadDatabaseList();
                updateDatabaseStats();
                renderProducts();
                updateStats();
                // renderChart(); // renderChart is called by applyFilters or renderProducts
                applyFilters(); // This will also call renderChart
                alert('æ•¸æ“šåº«å·²æ¸…ç©ºã€‚');
            }
        }
        
        function exportDatabase() {
            const data = Array.from(productDatabase.values());
            const jsonData = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mac_price_database_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importDatabase() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const content = await readFileContent(file); // Ensure readFileContent is defined
                    const importedData = JSON.parse(content);
                    
                    if (Array.isArray(importedData)) {
                        importedData.forEach(product => {
                            if (product.id && product.name && product.price) { // Basic validation
                                const key = product.dbKey || `${product.name}_${product.source}_${product.price}`;
                                productDatabase.set(key, {
                                    ...product,
                                    dbKey: key,
                                    lastUpdated: new Date(product.lastUpdated || Date.now()) // Ensure lastUpdated is a Date
                                });
                            }
                        });
                        
                        persistDatabase();
                        syncDatabaseToProducts();
                        loadDatabaseList();
                        updateDatabaseStats();
                        applyFilters();
                        alert(`æˆåŠŸåŒ¯å…¥ ${importedData.length} å€‹ç”¢å“åˆ°æ•¸æ“šåº«ã€‚`);
                    } else {
                        alert('åŒ¯å…¥æ–‡ä»¶æ ¼å¼éŒ¯èª¤ã€‚');
                    }
                } catch (error) {
                    console.error('åŒ¯å…¥å¤±æ•—:', error);
                    alert('åŒ¯å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ–‡ä»¶æ ¼å¼ã€‚');
                }
            };
            input.click();
        }

        // === AI Prompt ç”ŸæˆåŠŸèƒ½ ===
        function generatePriceAnalysisPrompt() {
            const priceData = compilePriceAnalysisData();
            currentPrompt = `# Mac ç”¢å“åƒ¹æ ¼åˆ†æè«‹æ±‚

## åˆ†æç›®æ¨™
è«‹åŸºæ–¼ä»¥ä¸‹ Mac ç”¢å“åƒ¹æ ¼æ•¸æ“šï¼Œæä¾›å°ˆæ¥­çš„åƒ¹æ ¼åˆ†æå’Œè³¼è²·å»ºè­°ã€‚

## ç”¢å“æ•¸æ“š
${priceData.productSummary}

## åƒ¹æ ¼çµ±è¨ˆ
- åƒ¹æ ¼ç¯„åœ: ${priceData.minPrice.toLocaleString()} - ${priceData.maxPrice.toLocaleString()}
- å¹³å‡åƒ¹æ ¼: ${priceData.avgPrice.toLocaleString()}
- æœ€å¤§åƒ¹å·®: ${priceData.priceDiff.toLocaleString()}
- åƒ¹æ ¼è®Šç•°æ•¸: Â±${priceData.variance.toLocaleString()}

## ä¾†æºåˆ†å¸ƒ
${priceData.sourceDistribution}

## ç‹€æ³åˆ†å¸ƒ
${priceData.conditionDistribution}

## åˆ†æè¦æ±‚
1. **åƒ¹æ ¼åˆç†æ€§åˆ†æ**: è©•ä¼°å„ç”¢å“çš„åƒ¹æ ¼æ˜¯å¦åˆç†
2. **æ€§åƒ¹æ¯”æ’å**: æŒ‰ç…§æ€§åƒ¹æ¯”å°ç”¢å“é€²è¡Œæ’å
3. **è³¼è²·æ™‚æ©Ÿå»ºè­°**: æ ¹æ“šåƒ¹æ ¼è¶¨å‹¢å»ºè­°æœ€ä½³è³¼è²·æ™‚æ©Ÿ
4. **é¢¨éšªè©•ä¼°**: ä¸åŒåƒ¹æ ¼å€é–“çš„ç”¢å“é¢¨éšªåˆ†æ
5. **çœéŒ¢ç­–ç•¥**: æä¾›å…·é«”çš„çœéŒ¢è³¼è²·ç­–ç•¥

## è¼¸å‡ºæ ¼å¼
è«‹ä»¥çµæ§‹åŒ–æ–¹å¼æä¾›åˆ†æçµæœï¼ŒåŒ…å«å…·é«”æ•¸æ“šæ”¯æ’å’Œå¯¦ç”¨å»ºè­°ã€‚`;

            displayPrompt(currentPrompt);
        }

        function generateSpecsAnalysisPrompt() {
            const specsData = compileSpecsAnalysisData();
            currentPrompt = `# Mac ç”¢å“è¦æ ¼å·®ç•°åˆ†æè«‹æ±‚

## åˆ†æç›®æ¨™
è«‹åŸºæ–¼ä»¥ä¸‹ Mac ç”¢å“è¦æ ¼æ•¸æ“šï¼Œæä¾›è©³ç´°çš„æŠ€è¡“è¦æ ¼åˆ†æå’Œé¸æ“‡å»ºè­°ã€‚

## ç”¢å“è¦æ ¼å°æ¯”
${specsData.specsComparison}

## è¦æ ¼åˆ†å¸ƒçµ±è¨ˆ
${specsData.specsDistribution}

## æ€§èƒ½è©•åˆ†
${specsData.performanceScores}

## ä½¿ç”¨å ´æ™¯åŒ¹é…
${specsData.useCaseData}

## åˆ†æè¦æ±‚
1. **è¦æ ¼å·®ç•°è§£æ**: è©³ç´°èªªæ˜å„è¦æ ¼å·®ç•°å°å¯¦éš›ä½¿ç”¨çš„å½±éŸ¿
2. **æ€§èƒ½ç“¶é ¸åˆ†æ**: è­˜åˆ¥å„é…ç½®çš„æ½›åœ¨æ€§èƒ½ç“¶é ¸
3. **å‡ç´šåƒ¹å€¼è©•ä¼°**: åˆ†æè¨˜æ†¶é«”ã€å„²å­˜ç©ºé–“å‡ç´šçš„æ€§åƒ¹æ¯”
4. **ä½¿ç”¨å ´æ™¯æ¨è–¦**: æ ¹æ“šä¸åŒä½¿ç”¨éœ€æ±‚æ¨è–¦æœ€é©åˆçš„é…ç½®
5. **æœªä¾†æ“´å±•æ€§**: è©•ä¼°å„é…ç½®çš„æœªä¾†æ“´å±•æ½›åŠ›

## æŠ€è¡“æ·±åº¦
è«‹æä¾›å°ˆæ¥­ç´šçš„æŠ€è¡“åˆ†æï¼ŒåŒ…å«å…·é«”çš„æ€§èƒ½æ•¸æ“šå’ŒåŸºæº–æ¸¬è©¦åƒè€ƒã€‚`;

            displayPrompt(currentPrompt);
        }

        function generatePurchaseAdvicePrompt() {
            const purchaseData = compilePurchaseAdviceData();
            currentPrompt = `# Mac è³¼è²·æ±ºç­–åˆ†æè«‹æ±‚

## åˆ†æç›®æ¨™
åŸºæ–¼æ”¶é›†çš„å¸‚å ´æ•¸æ“šï¼Œç‚ºç”¨æˆ¶æä¾›å€‹æ€§åŒ–çš„ Mac è³¼è²·å»ºè­°å’Œæ±ºç­–æ”¯æ´ã€‚

## å¸‚å ´ç¾æ³
${purchaseData.marketOverview}

## ç”¢å“æ¨è–¦æ¸…å–®
${purchaseData.recommendations}

## åƒ¹æ ¼è¶¨å‹¢é æ¸¬
${purchaseData.priceTrends}

## åº«å­˜ç‹€æ³
${purchaseData.availability}

## æ±ºç­–å› ç´ åˆ†æ
${purchaseData.decisionFactors}

## åˆ†æè¦æ±‚
1. **æœ€ä½³è³¼è²·æ™‚æ©Ÿ**: åŸºæ–¼åƒ¹æ ¼è¶¨å‹¢å’Œåº«å­˜ç‹€æ³çš„æ™‚æ©Ÿå»ºè­°
2. **é ç®—å„ªåŒ–ç­–ç•¥**: ä¸åŒé ç®—ç¯„åœçš„æœ€ä½³é…ç½®çµ„åˆ
3. **é¢¨éšªèˆ‡æ©Ÿæœƒ**: è³¼è²·æ±ºç­–ä¸­çš„é¢¨éšªå› ç´ å’Œæ©Ÿæœƒé»
4. **æ›¿ä»£æ–¹æ¡ˆ**: æä¾›å¤šç¨®å¯è¡Œçš„æ›¿ä»£è³¼è²·æ–¹æ¡ˆ
5. **é•·æœŸåƒ¹å€¼è©•ä¼°**: è€ƒæ…®æŠ˜èˆŠå’Œå‡ç´šé€±æœŸçš„é•·æœŸåƒ¹å€¼åˆ†æ

## å€‹äººåŒ–å»ºè­°
è«‹æä¾›å¯æ“ä½œçš„å…·é«”å»ºè­°ï¼ŒåŒ…å«è³¼è²·æ­¥é©Ÿå’Œæ³¨æ„äº‹é …ã€‚`;

            displayPrompt(currentPrompt);
        }

        function generateCompetitiveAnalysisPrompt() {
            const competitiveData = compileCompetitiveAnalysisData();
            currentPrompt = `# Mac å¸‚å ´ç«¶çˆ­åˆ†æè«‹æ±‚

## åˆ†æç›®æ¨™
æä¾› Mac ç”¢å“åœ¨ä¸åŒéŠ·å”®æ¸ é“é–“çš„ç«¶çˆ­æ…‹å‹¢åˆ†æå’Œå¸‚å ´æ´å¯Ÿã€‚

## æ¸ é“ç«¶çˆ­åˆ†æ
${competitiveData.channelAnalysis}

## ç”¢å“ç·šç«¶çˆ­åŠ›
${competitiveData.productLineAnalysis}

## åƒ¹æ ¼ç­–ç•¥åˆ†æ
${competitiveData.pricingStrategy}

## å¸‚å ´ä»½é¡ä¼°ç®—
${competitiveData.marketShare}

## æ¶ˆè²»è€…åå¥½è¶¨å‹¢
${competitiveData.consumerTrends}

## åˆ†æè¦æ±‚
1. **ç«¶çˆ­å„ªå‹¢è­˜åˆ¥**: å„éŠ·å”®æ¸ é“çš„ç«¶çˆ­å„ªå‹¢å’ŒåŠ£å‹¢
2. **å¸‚å ´å®šä½åˆ†æ**: ä¸åŒç”¢å“ç·šçš„å¸‚å ´å®šä½ç­–ç•¥
3. **åƒ¹æ ¼ç«¶çˆ­åŠ›**: åƒ¹æ ¼ç«¶çˆ­åŠ›å’Œå·®ç•°åŒ–ç­–ç•¥åˆ†æ
4. **æ¶ˆè²»è€…æ±ºç­–å› ç´ **: å½±éŸ¿æ¶ˆè²»è€…é¸æ“‡çš„é—œéµå› ç´ 
5. **å¸‚å ´æ©Ÿæœƒé»**: è­˜åˆ¥å¸‚å ´ç©ºç™½å’Œæ©Ÿæœƒé»

## å•†æ¥­æ´å¯Ÿ
è«‹æä¾›å…·æœ‰å•†æ¥­åƒ¹å€¼çš„æ·±åº¦æ´å¯Ÿå’Œç­–ç•¥å»ºè­°ã€‚`;

            displayPrompt(currentPrompt);
        }
        
        function compilePriceAnalysisData() {
            if (filteredProducts.length === 0) { // Handle empty filteredProducts
                return {
                    productSummary: "ç„¡ç”¢å“æ•¸æ“š",
                    minPrice: 0, maxPrice: 0, avgPrice: 0, priceDiff: 0, variance: 0,
                    sourceDistribution: "ç„¡ä¾†æºæ•¸æ“š", conditionDistribution: "ç„¡ç‹€æ³æ•¸æ“š"
                };
            }
            const prices = filteredProducts.map(p => p.price);
            const minPrice = Math.min(...prices);
            const maxPrice = Math.max(...prices);
            const avgPrice = Math.round(prices.reduce((a, b) => a + b, 0) / prices.length);
            const variance = prices.length > 1 ? Math.round(Math.sqrt(prices.reduce((sum, price) => sum + Math.pow(price - avgPrice, 2), 0) / (prices.length -1 ))) : 0; // Sample variance

            const productSummary = filteredProducts.map((p, i) => 
                `${i + 1}. ${p.name} - ${p.price.toLocaleString()} (${p.condition}) - ${p.source}`
            ).join('\n');

            const sourceCount = {};
            filteredProducts.forEach(p => {
                sourceCount[p.source] = (sourceCount[p.source] || 0) + 1;
            });
            const sourceDistribution = Object.entries(sourceCount)
                .map(([source, count]) => `- ${source}: ${count} å€‹ç”¢å“`)
                .join('\n') || "ç„¡ä¾†æºæ•¸æ“š";

            const conditionCount = {};
            filteredProducts.forEach(p => {
                conditionCount[p.condition] = (conditionCount[p.condition] || 0) + 1;
            });
            const conditionDistribution = Object.entries(conditionCount)
                .map(([condition, count]) => `- ${condition}: ${count} å€‹ç”¢å“`)
                .join('\n') || "ç„¡ç‹€æ³æ•¸æ“š";

            return {
                productSummary, minPrice, maxPrice, avgPrice,
                priceDiff: maxPrice - minPrice, variance,
                sourceDistribution, conditionDistribution
            };
        }

        function compileSpecsAnalysisData() {
            if (filteredProducts.length === 0) {
                 return {
                    specsComparison: "ç„¡ç”¢å“æ•¸æ“š", specsDistribution: "ç„¡è¦æ ¼æ•¸æ“š",
                    performanceScores: "ç„¡è©•åˆ†æ•¸æ“š", useCaseData: "ç„¡ä½¿ç”¨å ´æ™¯æ•¸æ“š"
                };
            }
            const uniqueProducts = getUniqueProductsByModel();
            
            const specsComparison = uniqueProducts.map((p, i) => `
${i + 1}. ${p.name}
   - è™•ç†å™¨: ${p.processor}
   - è¨˜æ†¶é«”: ${(p.memory || "").replace('GB', '')} GB
   - å„²å­˜: ${(p.storage || "").replace(/GB|TB/g, '')} ${(p.storage || "").includes("TB") ? "TB" : "GB"}
   - è¢å¹•: ${(p.screen || "").replace('å‹', '')} å‹
   - åƒ¹æ ¼: ${p.price.toLocaleString()}
   - ç‹€æ³: ${p.condition}`).join('\n');

            const memoryDist = getDistribution(filteredProducts, 'memory');
            const storageDist = getDistribution(filteredProducts, 'storage');
            const processorDist = getDistribution(filteredProducts, 'processor');

            const specsDistribution = `
è¨˜æ†¶é«”åˆ†å¸ƒ:
${Object.entries(memoryDist).map(([key, value]) => `- ${key}: ${value} å€‹ç”¢å“`).join('\n')}

å„²å­˜åˆ†å¸ƒ:
${Object.entries(storageDist).map(([key, value]) => `- ${key}: ${value} å€‹ç”¢å“`).join('\n')}

è™•ç†å™¨åˆ†å¸ƒ:
${Object.entries(processorDist).map(([key, value]) => `- ${key}: ${value} å€‹ç”¢å“`).join('\n')}`;

            const performanceScores = uniqueProducts.map(p => 
                `- ${p.name}: ${calculateValueScore(p).toFixed(2)} åˆ†`
            ).join('\n');

            const useCaseData = `
è¼•åº¦ä½¿ç”¨ (æ–‡æ›¸ã€ç¶²é ): 8GB RAM + 256GB SSD
ä¸­åº¦ä½¿ç”¨ (é–‹ç™¼ã€è¨­è¨ˆ): 16GB RAM + 512GB SSD  
é‡åº¦ä½¿ç”¨ (å½±ç‰‡ç·¨è¼¯): 32GB+ RAM + 1TB+ SSD
å°ˆæ¥­å·¥ä½œç«™: 64GB+ RAM + 2TB+ SSD`;

            return { specsComparison, specsDistribution, performanceScores, useCaseData };
        }

        function compilePurchaseAdviceData() {
             if (filteredProducts.length === 0) {
                return {
                    marketOverview: "ç„¡å¸‚å ´æ•¸æ“š", recommendations: "ç„¡æ¨è–¦æ•¸æ“š",
                    priceTrends: "ç„¡åƒ¹æ ¼è¶¨å‹¢æ•¸æ“š", availability: "ç„¡åº«å­˜æ•¸æ“š", decisionFactors: "ç„¡æ±ºç­–å› ç´ æ•¸æ“š"
                };
            }
            const sortedByPrice = [...filteredProducts].sort((a, b) => a.price - b.price);
            const bestValue = findBestValueProduct();

            const marketOverview = `
ç¸½ç”¢å“æ•¸: ${filteredProducts.length}
åƒ¹æ ¼ç¯„åœ: ${sortedByPrice[0].price.toLocaleString()} - ${sortedByPrice[sortedByPrice.length-1].price.toLocaleString()}
å¹³å‡åƒ¹æ ¼: ${Math.round(filteredProducts.reduce((sum, p) => sum + p.price, 0) / filteredProducts.length).toLocaleString()}
ä¸»è¦éŠ·å”®æ¸ é“: ${[...new Set(filteredProducts.map(p => p.source))].join(', ')}`;

            const recommendations = `
æœ€ä½³æ€§åƒ¹æ¯”: ${bestValue.name} - ${bestValue.price.toLocaleString()} (${bestValue.source})
é ç®—é¦–é¸: ${sortedByPrice[0].name} - ${sortedByPrice[0].price.toLocaleString()} (${sortedByPrice[0].source})
é«˜ç«¯é¸æ“‡: ${sortedByPrice[sortedByPrice.length-1].name} - ${sortedByPrice[sortedByPrice.length-1].price.toLocaleString()} (${sortedByPrice[sortedByPrice.length-1].source})`;

            const priceTrends = `
é æ¸¬è¶¨å‹¢: åŸºæ–¼ç•¶å‰æ•¸æ“šï¼Œé æœŸæœªä¾† 3-6 å€‹æœˆåƒ¹æ ¼å¯èƒ½ä¸‹é™ 2-5%
å­£ç¯€æ€§å› ç´ : é€šå¸¸åœ¨æ–°å“ç™¼å¸ƒå‰å¾Œåƒ¹æ ¼æ³¢å‹•è¼ƒå¤§
åº«å­˜å½±éŸ¿: ç†±é–€é…ç½®å¯èƒ½é¢è‡¨ç¼ºè²¨ï¼Œå½±éŸ¿åƒ¹æ ¼ç©©å®šæ€§`;

            const availability = filteredProducts.map(p => 
                `${p.name}: ${p.availability || 'æœªçŸ¥'} (${p.source})` // Added fallback for availability
            ).join('\n');

            const decisionFactors = `
ä¸»è¦è€ƒé‡å› ç´ :
1. é ç®—é™åˆ¶: ${Math.round(filteredProducts.reduce((sum, p) => sum + p.price, 0) / filteredProducts.length / 1000) * 1000} ç‚ºä¸»æµåƒ¹ä½
2. ä½¿ç”¨éœ€æ±‚: ä¸åŒè¦æ ¼é©åˆä¸åŒä½¿ç”¨å ´æ™¯
3. å“è³ªä¿è­‰: å…¨æ–°vsæ•´æ–°å“vsäºŒæ‰‹çš„é¢¨éšªè©•ä¼°
4. å”®å¾Œæœå‹™: ä¸åŒæ¸ é“çš„ä¿å›ºå’Œæœå‹™å·®ç•°`;

            return { marketOverview, recommendations, priceTrends, availability, decisionFactors };
        }

        function compileCompetitiveAnalysisData() {
            if (filteredProducts.length === 0) {
                return {
                    channelAnalysis: "ç„¡æ¸ é“æ•¸æ“š", productLineAnalysis: "ç„¡ç”¢å“ç·šæ•¸æ“š",
                    pricingStrategy: "ç„¡åƒ¹æ ¼ç­–ç•¥æ•¸æ“š", marketShare: "ç„¡å¸‚å ´ä»½é¡æ•¸æ“š", consumerTrends: "ç„¡æ¶ˆè²»è€…è¶¨å‹¢æ•¸æ“š"
                };
            }
            const sourceAnalysis = {};
            filteredProducts.forEach(p => {
                if (!sourceAnalysis[p.source]) {
                    sourceAnalysis[p.source] = {
                        products: [],
                        avgPrice: 0,
                        conditions: new Set()
                    };
                }
                sourceAnalysis[p.source].products.push(p);
                sourceAnalysis[p.source].conditions.add(p.condition);
            });

            Object.keys(sourceAnalysis).forEach(source => {
                const products = sourceAnalysis[source].products;
                if (products.length > 0) { // Avoid division by zero
                    sourceAnalysis[source].avgPrice = Math.round(
                        products.reduce((sum, p) => sum + p.price, 0) / products.length
                    );
                } else {
                    sourceAnalysis[source].avgPrice = 0;
                }
            });

            const channelAnalysis = Object.entries(sourceAnalysis).map(([source, data]) => `
${source}:
- ç”¢å“æ•¸é‡: ${data.products.length}
- å¹³å‡åƒ¹æ ¼: ${data.avgPrice.toLocaleString()}
- å•†å“ç‹€æ³: ${Array.from(data.conditions).join(', ')}
- åƒ¹æ ¼ç«¶çˆ­åŠ›: ${data.avgPrice < 40000 ? 'é«˜' : data.avgPrice < 60000 ? 'ä¸­' : 'ä½'}`).join('\n');

            const productLineAnalysis = `
MacBook Air: ${filteredProducts.filter(p => p.model === 'MacBook Air').length} å€‹ç”¢å“
MacBook Pro: ${filteredProducts.filter(p => p.model === 'MacBook Pro').length} å€‹ç”¢å“
iMac: ${filteredProducts.filter(p => p.model === 'iMac').length} å€‹ç”¢å“
Mac mini: ${filteredProducts.filter(p => p.model === 'Mac mini').length} å€‹ç”¢å“
å…¶ä»–: ${filteredProducts.filter(p => !['MacBook Air', 'MacBook Pro', 'iMac', 'Mac mini'].includes(p.model)).length} å€‹ç”¢å“`;

            const pricingStrategy = `
åƒ¹æ ¼ç­–ç•¥åˆ†æ:
- è˜‹æœå®˜æ–¹: çµ±ä¸€å®šåƒ¹ï¼Œæä¾›æ•™è‚²å„ªæƒ 
- é›»å•†å¹³å°: åƒ¹æ ¼ç«¶çˆ­æ¿€çƒˆï¼Œå¸¸æœ‰ä¿ƒéŠ·æ´»å‹•
- äºŒæ‰‹å¸‚å ´: åƒ¹æ ¼å·®ç•°å¤§ï¼Œå“è³ªåƒå·®ä¸é½Š
- æ•´æ–°å“: ä»‹æ–¼å…¨æ–°å’ŒäºŒæ‰‹ä¹‹é–“çš„å®šä½`;

            const marketShare = Object.entries(sourceAnalysis).map(([source, data]) => {
                const share = filteredProducts.length > 0 ? (data.products.length / filteredProducts.length * 100).toFixed(1) : 0;
                return `${source}: ${share}%`;
            }).join('\n');

            const consumerTrends = `
æ¶ˆè²»è€…åå¥½è¶¨å‹¢:
1. æ€§åƒ¹æ¯”å°å‘: è¶Šä¾†è¶Šæ³¨é‡è¦æ ¼èˆ‡åƒ¹æ ¼çš„å¹³è¡¡
2. å“è³ªä¿è­‰: å‚¾å‘é¸æ“‡æœ‰ä¿å›ºçš„æ¸ é“
3. é…ç½®å‡ç´š: 16GBè¨˜æ†¶é«”å’Œ512GBå„²å­˜æˆç‚ºä¸»æµéœ€æ±‚
4. ç’°ä¿æ„è­˜: æ•´æ–°å“å’ŒäºŒæ‰‹ç”¢å“æ¥å—åº¦æå‡`;

            return { channelAnalysis, productLineAnalysis, pricingStrategy, marketShare, consumerTrends };
        }

        function getDistribution(products, field) {
            const distribution = {};
            products.forEach(product => {
                const value = product[field];
                distribution[value] = (distribution[value] || 0) + 1;
            });
            return distribution;
        }

        function displayPrompt(prompt) {
            document.getElementById('aiPromptOutput').innerHTML = `
                <div class="prompt-section">
                    <pre>${prompt}</pre> <!-- Use <pre> for better formatting -->
                </div>
            `;
            document.getElementById('copyPromptBtn').disabled = false;
        }


        // ç¯„ä¾‹è³‡æ–™
        const sampleData = [
            {
                id: 1,
                name: 'MacBook Air M2 13å‹',
                model: 'MacBook Air',
                processor: 'Apple M2',
                memory: '8GB',
                storage: '256GB',
                screen: '13.6å‹',
                condition: 'new',
                price: 35900,
                originalPrice: 35900,
                source: 'Apple Store Taiwan',
                url: 'https://apple.com/tw',
                availability: 'ç¾è²¨',
                warranty: '1å¹´ä¿å›º',
                lastUpdated: new Date()
            },
            {
                id: 2,
                name: 'MacBook Air M2 13å‹',
                model: 'MacBook Air',
                processor: 'Apple M2',
                memory: '8GB',
                storage: '256GB',
                screen: '13.6å‹',
                condition: 'refurbished',
                price: 31900,
                originalPrice: 35900,
                source: 'Apple å®˜æ–¹æ•´æ–°å“',
                url: 'https://apple.com/tw/shop/refurbished',
                availability: 'ç¾è²¨',
                warranty: '1å¹´ä¿å›º',
                lastUpdated: new Date()
            },
            {
                id: 3,
                name: 'MacBook Pro M3 14å‹',
                model: 'MacBook Pro',
                processor: 'Apple M3',
                memory: '8GB',
                storage: '512GB',
                screen: '14.2å‹',
                condition: 'new',
                price: 61900,
                originalPrice: 61900,
                source: 'PChome 24h',
                url: 'https://24h.pchome.com.tw',
                availability: 'ç¾è²¨',
                warranty: '1å¹´ä¿å›º',
                lastUpdated: new Date()
            },
            {
                id: 4,
                name: 'MacBook Pro M3 14å‹',
                model: 'MacBook Pro',
                processor: 'Apple M3',
                memory: '8GB',
                storage: '512GB',
                screen: '14.2å‹',
                condition: 'student',
                price: 58800,
                originalPrice: 61900,
                source: 'Apple æ•™è‚²åƒ¹',
                url: 'https://apple.com/tw/shop/education',
                availability: 'ç¾è²¨',
                warranty: '1å¹´ä¿å›º',
                lastUpdated: new Date()
            },
            {
                id: 5,
                name: 'iMac M3 24å‹',
                model: 'iMac',
                processor: 'Apple M3',
                memory: '8GB',
                storage: '256GB',
                screen: '24å‹ 4.5K',
                condition: 'new',
                price: 48900,
                originalPrice: 48900,
                source: 'momoè³¼ç‰©ç¶²',
                url: 'https://momo.com.tw',
                availability: 'ç¾è²¨',
                warranty: '1å¹´ä¿å›º',
                lastUpdated: new Date()
            },
            {
                id: 6,
                name: 'MacBook Air M2 13å‹',
                model: 'MacBook Air',
                processor: 'Apple M2',
                memory: '8GB',
                storage: '256GB',
                screen: '13.6å‹',
                condition: 'used-a',
                price: 28900,
                originalPrice: 35900,
                source: 'äºŒæ‰‹å•†åŸ',
                url: 'https://example-used.com',
                availability: 'ç¾è²¨',
                warranty: '3å€‹æœˆä¿å›º',
                lastUpdated: new Date()
            },
            {
                id: 7,
                name: 'Mac mini M2',
                model: 'Mac mini',
                processor: 'Apple M2',
                memory: '8GB',
                storage: '256GB',
                screen: 'ç„¡',
                condition: 'new',
                price: 19900,
                originalPrice: 19900,
                source: 'ç‡¦å¤ç·šä¸Š',
                url: 'https://tkec.com.tw',
                availability: 'ç¾è²¨',
                warranty: '1å¹´ä¿å›º',
                lastUpdated: new Date()
            },
            {
                id: 8,
                name: 'MacBook Pro M3 Pro 14å‹',
                model: 'MacBook Pro',
                processor: 'Apple M3 Pro',
                memory: '16GB',
                storage: '512GB',
                screen: '14.2å‹',
                condition: 'new',
                price: 78900,
                originalPrice: 78900,
                source: 'é †ç™¼é›»è…¦',
                url: 'https://sunfar.com.tw',
                availability: 'é è³¼',
                warranty: '1å¹´ä¿å›º',
                lastUpdated: new Date()
            }
        ];

        // åˆå§‹åŒ–
        function initializeApp() {
            loadFromDatabase(); // Load from DB first
            setupEventListeners();
            if (productDatabase.size === 0) { // Only load sample if DB is empty
                loadSampleData();
            } else {
                syncDatabaseToProducts(); // Sync DB to working arrays
                applyFilters(); // Apply filters which also renders products, stats, and chart
            }
            initClipboardMonitor();
            // Initialize analysis panels after a short delay to ensure DOM is ready
            setTimeout(() => {
                switchAnalysisTab('price'); // Default to price analysis tab
            }, 100);
        }


        // è¨­å®šäº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            // ç¯©é¸å™¨è®Šæ›´äº‹ä»¶
            document.querySelectorAll('.filters-panel input[type="checkbox"], .filters-panel input[type="number"]').forEach(input => {
                input.addEventListener('change', applyFilters);
            });
        }

        // è¼‰å…¥ç¯„ä¾‹è³‡æ–™
        function loadSampleData() {
            showParseStatus('æ­£åœ¨è¼‰å…¥ç¯„ä¾‹æ•¸æ“š...');
            
            setTimeout(() => {
                updateParseProgress(30, 'æ­£åœ¨ç”Ÿæˆå¤šæ¨£åŒ–å•†å“æ•¸æ“š...');
                
                setTimeout(() => {
                    updateParseProgress(60, 'æ­£åœ¨æ¨¡æ“¬æ–‡ä»¶è§£æçµæœ...');
                    
                    setTimeout(() => {
                        updateParseProgress(90, 'æ­£åœ¨æ•´ç†æ•¸æ“šçµæ§‹...');
                        
                        setTimeout(() => {
                            // Clear existing data before loading sample data
                            // productDatabase.clear(); // Optionally clear DB if sample data should always overwrite
                            
                            sampleData.forEach(product => {
                                saveToDatabase(product); // Save sample data to DB
                            });
                            persistDatabase(); // Persist DB changes
                            syncDatabaseToProducts(); // Sync DB to working arrays
                                                        
                            // æ·»åŠ ä¸€äº›æ–‡ä»¶è§£æçš„æ¨¡æ“¬æ•¸æ“š
                            const parseSimulationData = [
                                {
                                    id: Date.now() + 100,
                                    name: 'MacBook Air M2 (ä¾†è‡ª CSV è§£æ)',
                                    model: 'MacBook Air',
                                    processor: 'Apple M2',
                                    memory: '16GB',
                                    storage: '512GB',
                                    screen: '13.6å‹',
                                    condition: 'new',
                                    price: 42900,
                                    originalPrice: 42900,
                                    source: 'uploaded_products.csv',
                                    url: '#',
                                    availability: 'ç¾è²¨',
                                    warranty: '1å¹´ä¿å›º',
                                    lastUpdated: new Date()
                                },
                                {
                                    id: Date.now() + 101,
                                    name: 'iMac 24å‹ M3 (ä¾†è‡ª HTML è§£æ)',
                                    model: 'iMac',
                                    processor: 'Apple M3',
                                    memory: '16GB',
                                    storage: '512GB',
                                    screen: '24å‹ 4.5K',
                                    condition: 'new',
                                    price: 62900,
                                    originalPrice: 62900,
                                    source: 'product_page.html',
                                    url: 'https://example.com/imac',
                                    availability: 'ç¾è²¨',
                                    warranty: '1å¹´ä¿å›º',
                                    lastUpdated: new Date()
                                }
                            ];
                            
                            parseSimulationData.forEach(product => {
                                saveToDatabase(product);
                            });
                            persistDatabase();
                            syncDatabaseToProducts();
                            
                            parseResults = parseSimulationData; // Keep this for specific UI if needed
                            
                            hideParseStatus();
                            applyFilters(); // This will render products, stats, and chart
                        }, 500);
                    }, 500);
                }, 500);
            }, 500);
        }

        // æ–°å¢ URL ä¾†æº
        async function addUrlSource() { // Made async
            const url = document.getElementById('websiteUrl').value.trim();
            if (!url) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ç¶²å€');
                return;
            }

            showParseStatus(`æ­£åœ¨åˆ†æç¶²å€: ${url}`);
            
            // æ¨¡æ“¬ç¶²é æŠ“å–å’Œæ™ºèƒ½è§£æéç¨‹
            await new Promise(resolve => setTimeout(resolve, 500));
            updateParseProgress(30, 'æ­£åœ¨æŠ“å–ç¶²é å…§å®¹...');
            await new Promise(resolve => setTimeout(resolve, 500));
            updateParseProgress(60, 'æ­£åœ¨è§£æå•†å“è³‡è¨Š...');
            await new Promise(resolve => setTimeout(resolve, 500));
            updateParseProgress(90, 'æ­£åœ¨çµæ§‹åŒ–æ•¸æ“š...');
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const newProduct = generateProductFromUrl(url);
            saveToDatabase(newProduct);
            persistDatabase();
            syncDatabaseToProducts();
            applyFilters();
            hideParseStatus();
            document.getElementById('websiteUrl').value = '';
            alert('æˆåŠŸæ–°å¢å•†å“è³‡æ–™ï¼');
        }

        // å¾ URL ç”Ÿæˆå•†å“è³‡æ–™ (æ™ºèƒ½åˆ†æ)
        function generateProductFromUrl(url) {
            const domain = new URL(url).hostname.toLowerCase();
            
            let source = domain;
            if (domain.includes('apple.com')) source = 'Apple Store Taiwan';
            else if (domain.includes('pchome')) source = 'PChome 24h';
            else if (domain.includes('momo')) source = 'momoè³¼ç‰©ç¶²';
            else if (domain.includes('shopee')) source = 'Shopee';
            else if (domain.includes('yahoo')) source = 'Yahooè³¼ç‰©ä¸­å¿ƒ';
            else if (domain.includes('ruten')) source = 'éœ²å¤©æ‹è³£';

            const urlPath = url.toLowerCase();
            let model = 'MacBook Air';
            let processor = 'Apple M2';
            let memory = '8GB';
            let storage = '256GB';
            let screen = '13.6å‹';
            let condition = 'new';
            let basePrice = 35900;
            let generatedUrl = url; // Default to original URL

            if (urlPath.includes('macbook-pro') || urlPath.includes('macbook_pro')) {
                model = 'MacBook Pro'; processor = 'Apple M3'; screen = '14.2å‹'; basePrice = 61900;
            } else if (urlPath.includes('imac')) {
                model = 'iMac'; screen = '24å‹ 4.5K'; basePrice = 48900;
            } else if (urlPath.includes('mac-mini') || urlPath.includes('mac_mini')) {
                model = 'Mac mini'; screen = 'ç„¡'; basePrice = 19900;
            } else if (urlPath.includes('mac-studio') || urlPath.includes('mac_studio')) {
                model = 'Mac Studio'; processor = 'Apple M2 Max'; screen = 'ç„¡'; basePrice = 79900;
            }

            if (urlPath.includes('16gb') || urlPath.includes('16-gb')) { memory = '16GB'; basePrice += 6000; }
            else if (urlPath.includes('32gb') || urlPath.includes('32-gb')) { memory = '32GB'; basePrice += 12000; }

            if (urlPath.includes('512gb') || urlPath.includes('512-gb')) { storage = '512GB'; basePrice += 6000; }
            else if (urlPath.includes('1tb') || urlPath.includes('1-tb')) { storage = '1TB'; basePrice += 12000; }

            if (urlPath.includes('refurbished') || urlPath.includes('æ•´æ–°')) { condition = 'refurbished'; basePrice = Math.round(basePrice * 0.85); }
            else if (urlPath.includes('used') || urlPath.includes('äºŒæ‰‹')) { condition = 'used-a'; basePrice = Math.round(basePrice * 0.75); }
            else if (urlPath.includes('education') || urlPath.includes('student')) { condition = 'student'; basePrice = Math.round(basePrice * 0.92); }

            const priceVariation = (Math.random() - 0.5) * 0.1; // Â±5%
            const finalPrice = Math.round(basePrice * (1 + priceVariation));

            // Attempt to generate a more specific URL for Apple Store
            if (source === 'Apple Store Taiwan' && (url === 'https://apple.com/tw' || url === 'https://www.apple.com/tw' || url === 'https://www.apple.com/tw/')) {
                let modelPath = model.toLowerCase().replace(/\s+/g, '-');
                if (model === 'MacBook Air') modelPath = 'macbook-air';
                else if (model === 'MacBook Pro') modelPath = 'macbook-pro';
                else if (model === 'iMac') modelPath = 'imac';
                else if (model === 'Mac mini') modelPath = 'mac-mini';
                else if (model === 'Mac Studio') modelPath = 'mac-studio';

                const processorPath = processor.toLowerCase().replace(/\s+/g, '-').replace('apple-', '');
                const memoryPath = memory.toLowerCase();
                const storagePath = storage.toLowerCase();
                // Simplified search query, actual Apple search URL might be different or use query parameters
                generatedUrl = `https://www.apple.com/tw/search/${modelPath}-${processorPath}-${memoryPath}-${storagePath}?src=globalnav`;
            }


            return {
                id: Date.now() + Math.random(), name: `${model} ${processor}`, model, processor, memory, storage, screen,
                condition, price: finalPrice, originalPrice: basePrice, source, url: generatedUrl,
                availability: Math.random() > 0.2 ? 'ç¾è²¨' : 'é è³¼',
                warranty: condition === 'new' ? '1å¹´ä¿å›º' : condition === 'refurbished' ? '1å¹´ä¿å›º' : '3å€‹æœˆä¿å›º',
                lastUpdated: new Date()
            };
        }

        // å¥—ç”¨ç¯©é¸æ¢ä»¶
        function applyFilters() {
            const modelFiltersChecked = {
                'macbook-air': document.getElementById('macbook-air').checked,
                'macbook-pro': document.getElementById('macbook-pro').checked,
                'imac': document.getElementById('imac').checked,
                'mac-mini': document.getElementById('mac-mini').checked,
                'mac-studio': document.getElementById('mac-studio').checked
            };
            const memoryFiltersChecked = {
                'ram-8gb': document.getElementById('ram-8gb').checked,
                'ram-16gb': document.getElementById('ram-16gb').checked,
                'ram-32gb': document.getElementById('ram-32gb').checked,
                'ram-64gb': document.getElementById('ram-64gb').checked
            };
            const storageFiltersChecked = {
                'storage-256gb': document.getElementById('storage-256gb').checked,
                'storage-512gb': document.getElementById('storage-512gb').checked,
                'storage-1tb': document.getElementById('storage-1tb').checked,
                'storage-2tb': document.getElementById('storage-2tb').checked
            };
            const conditionFiltersChecked = {
                'condition-new': document.getElementById('condition-new').checked,
                'condition-refurbished': document.getElementById('condition-refurbished').checked,
                'condition-used-a': document.getElementById('condition-used-a').checked,
                'condition-used-b': document.getElementById('condition-used-b').checked,
                'condition-used-c': document.getElementById('condition-used-c').checked,
                'condition-student': document.getElementById('condition-student').checked
            };
            const minPrice = parseInt(document.getElementById('minPrice').value) || 0;
            const maxPrice = parseInt(document.getElementById('maxPrice').value) || Infinity;

            filteredProducts = allProducts.filter(product => {
                const modelMap = { 'MacBook Air': 'macbook-air', 'MacBook Pro': 'macbook-pro', 'iMac': 'imac', 'Mac mini': 'mac-mini', 'Mac Studio': 'mac-studio' };
                if (!modelFiltersChecked[modelMap[product.model]]) return false;
                
                const memoryMap = { '8GB': 'ram-8gb', '16GB': 'ram-16gb', '32GB': 'ram-32gb' }; // Simplified, add more for 64GB+
                let memoryMatch = false;
                if (memoryFiltersChecked[memoryMap[product.memory]]) memoryMatch = true;
                if (product.memory.includes('64GB') || product.memory.includes('128GB')) { // Handle 64GB+
                    if (memoryFiltersChecked['ram-64gb']) memoryMatch = true;
                }
                if (!memoryMatch && (memoryFiltersChecked['ram-8gb'] || memoryFiltersChecked['ram-16gb'] || memoryFiltersChecked['ram-32gb'] || memoryFiltersChecked['ram-64gb'])) { // if any memory filter is active
                     if (!memoryFiltersChecked[memoryMap[product.memory]] && !( (product.memory.includes('64GB') || product.memory.includes('128GB')) && memoryFiltersChecked['ram-64gb'] )) return false;
                }


                const storageMap = { '256GB': 'storage-256gb', '512GB': 'storage-512gb', '1TB': 'storage-1tb' }; // Simplified
                let storageMatch = false;
                if (storageFiltersChecked[storageMap[product.storage]]) storageMatch = true;
                 if (product.storage.includes('2TB') || product.storage.includes('4TB') || product.storage.includes('8TB') ) { // Handle 2TB+
                    if (storageFiltersChecked['storage-2tb']) storageMatch = true;
                }
                if (!storageMatch && (storageFiltersChecked['storage-256gb'] || storageFiltersChecked['storage-512gb'] || storageFiltersChecked['storage-1tb'] || storageFiltersChecked['storage-2tb'])) {
                    if (!storageFiltersChecked[storageMap[product.storage]] && !( (product.storage.includes('2TB') || product.storage.includes('4TB') || product.storage.includes('8TB')) && storageFiltersChecked['storage-2tb'] )) return false;
                }


                const conditionMap = { 'new': 'condition-new', 'refurbished': 'condition-refurbished', 'used-a': 'condition-used-a', 'used-b': 'condition-used-b', 'used-c': 'condition-used-c', 'student': 'condition-student' };
                if (!conditionFiltersChecked[conditionMap[product.condition]]) return false;

                if (product.price < minPrice || product.price > maxPrice) return false;

                return true;
            });

            renderProducts();
            updateStats();
            renderChart(); // Called by switchAnalysisTab or directly if needed
            if (document.getElementById('priceAnalysisPanel').style.display !== 'none') updatePriceAnalysis();
            if (document.getElementById('specsAnalysisPanel').style.display !== 'none') updateSpecsAnalysis();
            if (document.getElementById('trendsAnalysisPanel').style.display !== 'none') updateTrendsAnalysis();
        }

        // æ¸²æŸ“å•†å“
        function renderProducts() {
            const container = document.getElementById('products-container');
            
            if (filteredProducts.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 3rem; color: #666;">æœªæ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„å•†å“</div>';
                return;
            }

            if (currentView === 'grid') {
                container.className = 'products-grid';
                container.innerHTML = filteredProducts.map(product => createProductCard(product)).join('');
            } else if (currentView === 'table') {
                container.className = ''; // Remove grid class for table view
                container.innerHTML = createProductTable(filteredProducts);
            }
            // Chart view is handled by switchView
        }

        // å»ºç«‹å•†å“å¡ç‰‡
        function createProductCard(product) {
            const conditionText = {
                'new': 'å…¨æ–°', 'refurbished': 'å®˜æ–¹æ•´æ–°å“', 'used-a': 'äºŒæ‰‹ A ç´š',
                'used-b': 'äºŒæ‰‹ B ç´š', 'used-c': 'äºŒæ‰‹ C ç´š', 'student': 'æ•™è‚²åƒ¹'
            };
            const discount = product.originalPrice && product.originalPrice !== product.price 
                ? Math.round((1 - product.price / product.originalPrice) * 100) : 0;

            let sourceIcon = 'ğŸŒ'; let sourceType = 'URL æŠ“å–';
            if (product.source.includes('.csv')) { sourceIcon = 'ğŸ“Š'; sourceType = 'CSV è§£æ'; }
            else if (product.source.includes('.html')) { sourceIcon = 'ğŸ”'; sourceType = 'HTML è§£æ'; }
            else if (product.source.includes('.md')) { sourceIcon = 'ğŸ“'; sourceType = 'Markdown è§£æ'; }
            else if (product.source.includes('.txt')) { sourceIcon = 'ğŸ“„'; sourceType = 'TXT è§£æ'; }

            return `
                <div class="product-card">
                    <div class="product-header">
                        <div class="product-title">${product.name}</div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <div class="condition-badge condition-${product.condition}">
                                ${conditionText[product.condition] || product.condition}
                            </div>
                        </div>
                    </div>
                    <div class="product-specs">
                        <div class="spec-item"><span class="spec-label">è™•ç†å™¨</span><span class="spec-value">${product.processor}</span></div>
                        <div class="spec-item"><span class="spec-label">è¨˜æ†¶é«” (GB)</span><span class="spec-value">${(product.memory || "").replace('GB', '')}</span></div>
                        <div class="spec-item"><span class="spec-label">å„²å­˜ç©ºé–“ (GB/TB)</span><span class="spec-value">${(product.storage || "").replace(/GB|TB/g, '')}</span></div>
                        <div class="spec-item"><span class="spec-label">è¢å¹• (å‹)</span><span class="spec-value">${(product.screen || "").replace('å‹', '')}</span></div>
                        <div class="spec-item"><span class="spec-label">ä¾›è²¨ç‹€æ³</span><span class="spec-value">${product.availability || 'æœªçŸ¥'}</span></div>
                    </div>
                    <div class="product-price">
                        <span class="price-amount">${product.price.toLocaleString()}</span>
                        <span class="price-currency">TWD</span>
                        ${discount > 0 ? `<div style="font-size: 0.9rem; color: #30D158; margin-top: 0.2rem;">çœä¸‹ ${discount}%</div>` : ''}
                    </div>
                    <div class="product-source">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 0.3rem;">
                            <span style="font-size: 1.2rem;">${sourceIcon}</span>
                            <span style="font-size: 0.8rem; color: #007AFF; font-weight: 500;">${sourceType}</span> <!-- Blueprint: ä¸»è‰² for link-like text -->
                        </div>
                        <div style="font-size: 0.9rem;">ğŸ“ ${product.source}</div>
                    </div>
                    <div class="product-actions">
                        <button class="btn btn-small" onclick="window.open('${product.url}', '_blank')" ${product.url === '#' ? 'disabled style="opacity: 0.5;"' : ''}>
                            ${product.url === '#' ? 'ç„¡é€£çµ' : 'å‰å¾€è³¼è²·'}
                        </button>
                        <button class="btn btn-small btn-secondary" onclick="addToCompare(${product.id})">
                            åŠ å…¥æ¯”è¼ƒ
                        </button>
                    </div>
                </div>`;
        }

        // å»ºç«‹å•†å“è¡¨æ ¼
        function createProductTable(products) {
            const conditionText = {
                'new': 'å…¨æ–°', 'refurbished': 'å®˜æ–¹æ•´æ–°å“', 'used-a': 'äºŒæ‰‹ A ç´š',
                'used-b': 'äºŒæ‰‹ B ç´š', 'used-c': 'äºŒæ‰‹ C ç´š', 'student': 'æ•™è‚²åƒ¹'
            };
            return `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                        <thead>
                            <tr style="background: #F8F9FA; border-bottom: 2px solid #E5E5EA;">
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">ç”¢å“åç¨±</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">è¦æ ¼</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">ç‹€æ³</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">åƒ¹æ ¼</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">ä¾†æº</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600;">å‹•ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${products.map(product => `
                                <tr style="border-bottom: 1px solid #F2F2F7;">
                                    <td style="padding: 1rem; font-weight: 600;">${product.name}</td>
                                    <td style="padding: 1rem; font-size: 0.9rem; color: #666;">
                                        ${product.processor}<br>
                                        ${(product.memory || "").replace('GB', '')}GB / ${(product.storage || "").replace(/GB|TB/g, '')}${(product.storage || "").includes("TB") ? "TB" : "GB"}
                                    </td>
                                    <td style="padding: 1rem;">
                                        <span class="condition-badge condition-${product.condition}">
                                            ${conditionText[product.condition] || product.condition}
                                        </span>
                                    </td>
                                    <td style="padding: 1rem; font-size: 1.2rem; font-weight: 600; color: #007AFF;"> <!-- Blueprint: ä¸»è‰² -->
                                        $${product.price.toLocaleString()}
                                    </td>
                                    <td style="padding: 1rem; font-size: 0.9rem; color: #666;">${product.source}</td>
                                    <td style="padding: 1rem;">
                                        <button class="btn btn-small" onclick="window.open('${product.url}', '_blank')" ${product.url === '#' ? 'disabled' : ''}>è³¼è²·</button>
                                        <button class="btn btn-small btn-secondary" onclick="addToCompare(${product.id})">æ¯”è¼ƒ</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>`;
        }

        // åˆ‡æ›æª¢è¦–æ¨¡å¼
        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active'); // Make sure event is passed or use a direct reference
            
            const productsContainer = document.getElementById('products-container');
            if (view === 'chart') {
                productsContainer.innerHTML = '<div class="chart-container" style="height: 400px;"><canvas id="detailChart"></canvas></div>';
                renderDetailChart();
            } else {
                renderProducts();
            }
        }

        // æ›´æ–°çµ±è¨ˆè³‡è¨Š
        function updateStats() {
            const total = filteredProducts.length;
            const average = total > 0 ? Math.round(filteredProducts.reduce((sum, p) => sum + p.price, 0) / total) : 0;
            const prices = filteredProducts.map(p => p.price);
            const priceRange = total > 0 && prices.length > 0 ? Math.max(...prices) - Math.min(...prices) : 0;
            const sources = new Set(filteredProducts.map(p => p.source)).size;

            document.getElementById('totalProducts').textContent = total;
            document.getElementById('averagePrice').textContent = `$${average.toLocaleString()}`;
            document.getElementById('priceRange').textContent = `$${priceRange.toLocaleString()}`;
            document.getElementById('sourcesCount').textContent = sources;
        }

        // æ¸²æŸ“åƒ¹æ ¼åœ–è¡¨ (This function seems to be for a different chart, priceChart is not globally defined in the last HTML block)
        // The main chart rendering logic is within updatePriceAnalysis, updateSpecsAnalysis, updateTrendsAnalysis
        // This function might be a leftover or intended for a different chart.
        // For now, ensure renderChart calls the correct analysis update.
        let priceChartInstance = null; // Specific instance for the scatter plot if needed
        function renderChart() { // This function is called by applyFilters
            // The actual chart rendering is now part of switchAnalysisTab and its helper functions.
            // This function can be a general trigger or be removed if switchAnalysisTab handles all cases.
            // For now, let's assume it might be for a general overview chart if one existed.
            // If currentAnalysisTab is 'price', 'specs', or 'trends', their respective update functions will handle charts.
            const activeTab = document.querySelector('.analysis-tab.active');
            if (activeTab) {
                switchAnalysisTab(activeTab.dataset.tab);
            } else {
                 switchAnalysisTab('price'); // Default if no tab is active
            }
        }


        // æ¸²æŸ“è©³ç´°åœ–è¡¨ (Doughnut chart for price distribution)
        function renderDetailChart() { // This is for the 'chart' view in results-section
            const ctx = document.getElementById('detailChart').getContext('2d');
            if (window.detailChartInstance) {
                window.detailChartInstance.destroy();
            }
            
            const priceRanges = ['<20K', '20K-40K', '40K-60K', '60K-80K', '80K+'];
            const rangeCounts = [0, 0, 0, 0, 0];

            filteredProducts.forEach(product => {
                if (product.price < 20000) rangeCounts[0]++;
                else if (product.price < 40000) rangeCounts[1]++;
                else if (product.price < 60000) rangeCounts[2]++;
                else if (product.price < 80000) rangeCounts[3]++;
                else rangeCounts[4]++;
            });

            window.detailChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: priceRanges,
                    datasets: [{ data: rangeCounts, backgroundColor: ['#30D158', '#34C759', '#007AFF', '#FF9500', '#FF3B30'] }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'åƒ¹æ ¼åˆ†ä½ˆåœ–', font: { size: 16, weight: 'bold' } } } }
            });
        }
        
        // åŠ å…¥æ¯”è¼ƒ (Placeholder, blueprint suggests more complex functionality)
        function addToCompare(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (product) {
                const compareInfo = `å·²åŠ å…¥æ¯”è¼ƒ: ${product.name}\nåƒ¹æ ¼: ${product.price.toLocaleString()}\nè¦æ ¼: ${product.processor}, ${product.memory}, ${product.storage}\nä¾†æº: ${product.source}`;
                alert(compareInfo);
                console.log('åŠ å…¥æ¯”è¼ƒçš„ç”¢å“:', product);
            }
        }


        // åŒ¯å‡ºè³‡æ–™
        function exportData() { // Renamed from exportDatabase to avoid conflict if a different exportData was intended
            if (filteredProducts.length === 0) {
                alert('æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™ã€‚');
                return;
            }
            const data = filteredProducts.map(product => ({
                'ç”¢å“åç¨±': product.name, 'å‹è™Ÿ': product.model, 'è™•ç†å™¨': product.processor,
                'è¨˜æ†¶é«”': product.memory, 'å„²å­˜ç©ºé–“': product.storage, 'è¢å¹•': product.screen,
                'ç‹€æ³': product.condition, 'åƒ¹æ ¼': product.price, 'ä¾†æº': product.source, 'ç¶²å€': product.url
            }));
            const csv = convertToCSV(data);
            downloadCSV(csv, 'mac_price_comparison.csv');
        }

        function convertToCSV(data) {
            if (!data || data.length === 0) return "";
            const headers = Object.keys(data[0]).join(',');
            const rows = data.map(row => Object.values(row).map(val => `"${String(val || '').replace(/"/g, '""')}"`).join(',')); // Handle null/undefined and escape quotes
            return [headers, ...rows].join('\n');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); // Added charset
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function showLoading() { document.getElementById('loading').style.display = 'block'; document.getElementById('products-container').style.display = 'none'; }
        function hideLoading() { document.getElementById('loading').style.display = 'none'; document.getElementById('products-container').style.display = 'block'; }
        
        // === è¦–è¦ºåŒ–åˆ†æåŠŸèƒ½ ===
        let currentAnalysisTab = 'price';
        // currentPrompt is already defined globally

        function switchAnalysisTab(tab) {
            document.querySelectorAll('.analysis-tab').forEach(t => t.classList.remove('active'));
            const activeTabButton = document.querySelector(`.analysis-tab[data-tab="${tab}"]`);
            if (activeTabButton) activeTabButton.classList.add('active');
            
            document.querySelectorAll('.analysis-panel').forEach(panel => panel.style.display = 'none');
            const targetPanel = document.getElementById(`${tab}AnalysisPanel`);
            if (targetPanel) targetPanel.style.display = 'block';
            
            currentAnalysisTab = tab;
            
            switch(tab) {
                case 'price': updatePriceAnalysis(); break;
                case 'specs': updateSpecsAnalysis(); break;
                case 'trends': updateTrendsAnalysis(); break;
                case 'ai': /* AI panel updated on button click */ break;
            }
        }

        function updatePriceAnalysis() {
            if (filteredProducts.length === 0) {
                document.getElementById('priceDifferenceStats').innerHTML = '<p>ç„¡ç”¢å“å¯åˆ†æ</p>';
                document.getElementById('bestPriceRecommendations').innerHTML = '<p>ç„¡ç”¢å“å¯æ¨è–¦</p>';
                if (window.priceComparisonChartInstance) window.priceComparisonChartInstance.destroy();
                return;
            }
            const prices = filteredProducts.map(p => p.price);
            const minPrice = Math.min(...prices); const maxPrice = Math.max(...prices);
            const avgPrice = Math.round(prices.reduce((a, b) => a + b, 0) / prices.length);
            const priceDiff = maxPrice - minPrice;
            const priceVariance = prices.length > 1 ? Math.round(Math.sqrt(prices.reduce((sum, price) => sum + Math.pow(price - avgPrice, 2), 0) / (prices.length -1 ))) : 0; // Sample variance

            document.getElementById('priceDifferenceStats').innerHTML = `
                <div class="price-difference-item"><span><strong>åƒ¹æ ¼ç¯„åœ</strong></span><span style="color: #007AFF; font-weight: 600;">${minPrice.toLocaleString()} - ${maxPrice.toLocaleString()}</span></div> <!-- Blueprint: ä¸»è‰² -->
                <div class="price-difference-item ${priceDiff > 10000 ? 'price-difference-negative' : 'price-difference-positive'}"><span><strong>æœ€å¤§åƒ¹å·®</strong></span><span style="font-weight: 600;">${priceDiff.toLocaleString()}</span></div>
                <div class="price-difference-item"><span><strong>å¹³å‡åƒ¹æ ¼</strong></span><span style="color: #34C759; font-weight: 600;">${avgPrice.toLocaleString()}</span></div> <!-- Blueprint: æ¬¡è¦è‰² -->
                <div class="price-difference-item"><span><strong>åƒ¹æ ¼æ¨™æº–å·®</strong></span><span style="color: #FF9500; font-weight: 600;">Â±${priceVariance.toLocaleString()}</span></div>`; /* Blueprint: å¼·èª¿è‰² */

            const recommendations = generatePriceRecommendations();
            document.getElementById('bestPriceRecommendations').innerHTML = recommendations;
            renderPriceComparisonChart();
        }

        function generatePriceRecommendations() {
            if (filteredProducts.length === 0) return '<p>ç„¡ç”¢å“å¯æ¨è–¦</p>';
            const sortedProducts = [...filteredProducts].sort((a, b) => a.price - b.price);
            const bestValue = findBestValueProduct();
            const cheapest = sortedProducts[0];
            const premium = sortedProducts[sortedProducts.length - 1];

            return `
                <div style="margin-bottom: 1rem;"><h4 style="color: #30D158; margin-bottom: 0.5rem;">ğŸ† æœ€ä½³æ€§åƒ¹æ¯”</h4><div style="background: white; padding: 0.8rem; border-radius: 6px; border-left: 4px solid #30D158;"><strong>${bestValue.name}</strong><br><span style="color: #007AFF;">${bestValue.price.toLocaleString()}</span> - ${bestValue.source}</div></div>
                <div style="margin-bottom: 1rem;"><h4 style="color: #007AFF; margin-bottom: 0.5rem;">ğŸ’° æœ€ä¾¿å®œé¸é …</h4><div style="background: white; padding: 0.8rem; border-radius: 6px; border-left: 4px solid #007AFF;"><strong>${cheapest.name}</strong><br><span style="color: #007AFF;">${cheapest.price.toLocaleString()}</span> - ${cheapest.source}</div></div>
                <div><h4 style="color: #FF9500; margin-bottom: 0.5rem;">â­ é ‚ç´šé…ç½®</h4><div style="background: white; padding: 0.8rem; border-radius: 6px; border-left: 4px solid #FF9500;"><strong>${premium.name}</strong><br><span style="color: #007AFF;">${premium.price.toLocaleString()}</span> - ${premium.source}</div></div>`;
        }

        function findBestValueProduct() {
            if (filteredProducts.length === 0) return { name: "N/A", price: 0, source: "N/A" }; // Fallback
            return filteredProducts.reduce((best, current) => {
                const currentScore = calculateValueScore(current);
                const bestScore = calculateValueScore(best);
                return currentScore > bestScore ? current : best;
            }, filteredProducts[0]); // Provide initial value for reduce
        }

        function calculateValueScore(product) {
            const memoryScore = getMemoryScore(product.memory);
            const storageScore = getStorageScore(product.storage);
            const processorScore = getProcessorScore(product.processor);
            const conditionScore = getConditionScore(product.condition);
            const totalSpecs = memoryScore + storageScore + processorScore + conditionScore;
            return product.price > 0 ? totalSpecs / (product.price / 1000) : 0; // Avoid division by zero
        }

        function getMemoryScore(memory) { const scores = { '8GB': 1, '16GB': 2, '32GB': 4, '64GB': 6, '128GB': 8 }; return scores[memory] || 1; }
        function getStorageScore(storage) { const scores = { '256GB': 1, '512GB': 2, '1TB': 4, '2TB': 6, '4TB': 8, '8TB': 10 }; return scores[storage] || 1; }
        function getProcessorScore(processor = "") { // Added default value
            if (processor.includes('M3 Ultra')) return 10; if (processor.includes('M3 Max')) return 8; if (processor.includes('M3 Pro')) return 6;
            if (processor.includes('M3')) return 5; if (processor.includes('M2')) return 4; if (processor.includes('M1')) return 3; return 2;
        }
        function getConditionScore(condition) { const scores = { 'new': 3, 'refurbished': 2.5, 'student': 3, 'used-a': 2, 'used-b': 1.5, 'used-c': 1 }; return scores[condition] || 1; }

        function updateSpecsAnalysis() {
            if (filteredProducts.length === 0) {
                document.getElementById('specsComparisonTable').innerHTML = '<p>ç„¡ç”¢å“å¯åˆ†æ</p>';
                if(window.specsDistributionChartInstance) window.specsDistributionChartInstance.destroy();
                if(window.performanceScoreChartInstance) window.performanceScoreChartInstance.destroy();
                return;
            }
            generateSpecsComparisonTable();
            renderSpecsDistributionChart();
            renderPerformanceScoreChart();
            enhanceSpecsComparison();
        }

        function generateSpecsComparisonTable() {
            const uniqueProducts = getUniqueProductsByModel();
            if (uniqueProducts.length === 0) {
                 document.getElementById('specsComparisonTable').innerHTML = '<p>ç„¡ç¨ç‰¹ç”¢å“å‹è™Ÿå¯æ¯”è¼ƒ</p>';
                 return;
            }
            
            const table = `
                <div class="specs-comparison-grid">
                    <div class="specs-cell specs-header">ç”¢å“å‹è™Ÿ</div>
                    ${uniqueProducts.map(p => `<div class="specs-cell specs-header">${p.model}</div>`).join('')}
                    <div class="specs-cell specs-header">è™•ç†å™¨</div>
                    ${uniqueProducts.map(p => `<div class="specs-cell ${hasSpecsDifference(uniqueProducts, 'processor') ? 'specs-different' : ''}">${p.processor}</div>`).join('')}
                    <div class="specs-cell specs-header">è¨˜æ†¶é«”</div>
                    ${uniqueProducts.map(p => `<div class="specs-cell ${hasSpecsDifference(uniqueProducts, 'memory') ? 'specs-different' : ''}">${p.memory}</div>`).join('')}
                    <div class="specs-cell specs-header">å„²å­˜ç©ºé–“</div>
                    ${uniqueProducts.map(p => `<div class="specs-cell ${hasSpecsDifference(uniqueProducts, 'storage') ? 'specs-different' : ''}">${p.storage}</div>`).join('')}
                    <div class="specs-cell specs-header">è¢å¹•</div>
                    ${uniqueProducts.map(p => `<div class="specs-cell ${hasSpecsDifference(uniqueProducts, 'screen') ? 'specs-different' : ''}">${p.screen}</div>`).join('')}
                    <div class="specs-cell specs-header">åƒ¹æ ¼</div>
                    ${uniqueProducts.map(p => `<div class="specs-cell" style="color: #007AFF; font-weight: 600;">${p.price.toLocaleString()}</div>`).join('')}
                    <div class="specs-cell specs-header">æ€§èƒ½è©•åˆ†</div>
                    ${uniqueProducts.map(p => {
                        const score = calculateValueScore(p);
                        const level = score > 3 ? 'high' : score > 1.5 ? 'medium' : 'low';
                        return `<div class="specs-cell">${score.toFixed(1)}<span class="performance-badge performance-${level}" style="background-color:${level === 'high' ? '#30D158' : level === 'medium' ? '#FFCC00' : '#FF3B30'}; color: ${level === 'medium' ? '#1D1D1F' : 'white'};">${level.toUpperCase()}</span></div>`;
                    }).join('')}
                </div>`;
            document.getElementById('specsComparisonTable').innerHTML = table;
        }

        function getUniqueProductsByModel() {
            const seen = new Set();
            return filteredProducts.filter(product => {
                const key = `${product.model}_${product.memory}_${product.storage}`;
                if (seen.has(key)) return false;
                seen.add(key); return true;
            }).slice(0, 6);
        }

        function hasSpecsDifference(products, field) { const values = new Set(products.map(p => p[field])); return values.size > 1; }
        
        function updateTrendsAnalysis() { renderTrendAnalysisChart(); } // Default to price distribution

        async function generateTrendForecast() { // Made async
            showParseStatus('æ­£åœ¨ç”Ÿæˆåƒ¹æ ¼è¶¨å‹¢é æ¸¬...');
            await new Promise(resolve => setTimeout(resolve, 2000)); // Simulate async operation
            const forecast = generateMockForecast();
            renderTrendAnalysisChart(forecast); // Pass forecast data
            hideParseStatus();
            alert('è¶¨å‹¢é æ¸¬å·²ç”Ÿæˆï¼åœ–è¡¨é¡¯ç¤ºæœªä¾† 6 å€‹æœˆçš„åƒ¹æ ¼é æ¸¬ã€‚');
        }
        
        async function analyzePricePattern() { // Made async
            showParseStatus('æ­£åœ¨åˆ†æåƒ¹æ ¼æ¨¡å¼...');
            await new Promise(resolve => setTimeout(resolve, 1500)); // Simulate async operation
            const patterns = analyzePricePatterns();
            displayPricePatterns(patterns);
            hideParseStatus();
        }
        
        async function showPriceDistribution() { // Made async
            showParseStatus('æ­£åœ¨ç”Ÿæˆåƒ¹æ ¼åˆ†å¸ƒåˆ†æ...');
            await new Promise(resolve => setTimeout(resolve, 1000));
            renderPriceDistributionChart(); // Specific function for doughnut chart
            hideParseStatus();
            document.getElementById('pricePatternResults').style.display = 'block';
            document.getElementById('pricePatternResults').innerHTML = generatePriceDistributionSummary();
        }

        function generatePriceDistributionSummary() {
            if (filteredProducts.length === 0) return '<p>ç„¡æ•¸æ“šå¯åˆ†æ</p>';
            const prices = filteredProducts.map(p => p.price).sort((a, b) => a - b);
            const q1 = prices[Math.floor(prices.length * 0.25)];
            const median = prices[Math.floor(prices.length * 0.5)];
            const q3 = prices[Math.floor(prices.length * 0.75)];
            const iqr = q3 - q1;
            return `
                <div style="background: #F8F9FA; padding: 1rem; border-radius: 8px;">
                    <h4 style="margin-bottom: 1rem;">ğŸ“Š åƒ¹æ ¼åˆ†å¸ƒçµ±è¨ˆ</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div class="price-difference-item"><span><strong>ç¬¬ä¸€å››åˆ†ä½æ•¸ (Q1)</strong></span><span style="color: #007AFF; font-weight: 600;">${q1.toLocaleString()}</span></div>
                        <div class="price-difference-item"><span><strong>ä¸­ä½æ•¸ (Q2)</strong></span><span style="color: #34C759; font-weight: 600;">${median.toLocaleString()}</span></div>
                        <div class="price-difference-item"><span><strong>ç¬¬ä¸‰å››åˆ†ä½æ•¸ (Q3)</strong></span><span style="color: #FF9500; font-weight: 600;">${q3.toLocaleString()}</span></div>
                        <div class="price-difference-item"><span><strong>å››åˆ†ä½è· (IQR)</strong></span><span style="color: #5856D6; font-weight: 600;">${iqr.toLocaleString()}</span></div>
                    </div>
                    <div style="margin-top: 1rem;"><p><strong>åˆ†æçµæœï¼š</strong></p><ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: #666;">
                        <li>50% çš„ç”¢å“åƒ¹æ ¼ä»‹æ–¼ ${q1.toLocaleString()} - ${q3.toLocaleString()} ä¹‹é–“</li>
                        <li>ä¸­ä½æ•¸åƒ¹æ ¼ç‚º ${median.toLocaleString()}ï¼Œæ˜¯è¼ƒç‚ºå‡è¡¡çš„é¸æ“‡</li>
                        <li>åƒ¹æ ¼é›¢æ•£ç¨‹åº¦ï¼š${iqr > 20000 ? 'è¼ƒé«˜' : iqr > 10000 ? 'ä¸­ç­‰' : 'è¼ƒä½'}</li>
                    </ul></div></div>`;
        }
        
        function enhanceSpecsComparison() {
            if (filteredProducts.length === 0) return;
            const similarityData = calculateSpecsSimilarity();
            if (similarityData.products.length > 0) { // Ensure there are products to compare
                 displaySimilarityMatrix(similarityData);
            }
        }

        function calculateSpecsSimilarity() {
            const products = getUniqueProductsByModel();
            const similarity = [];
            for (let i = 0; i < products.length; i++) {
                similarity[i] = [];
                for (let j = 0; j < products.length; j++) {
                    if (i === j) similarity[i][j] = 1;
                    else similarity[i][j] = compareProductSpecs(products[i], products[j]);
                }
            }
            return { products, similarity };
        }

        function compareProductSpecs(p1, p2) {
            let score = 0; let total = 0;
            if (p1.processor === p2.processor) score++; total++;
            if (p1.memory === p2.memory) score++; total++;
            if (p1.storage === p2.storage) score++; total++;
            if (p1.screen === p2.screen) score++; total++;
            if (p1.model === p2.model) score += 0.5; total += 0.5;
            return total > 0 ? score / total : 0;
        }

        function displaySimilarityMatrix(data) {
            const { products, similarity } = data;
            if (products.length === 0) return; // Don't display if no products
            let matrixHtml = `
                <div style="margin-top: 1.5rem; background: #F8F9FA; padding: 1rem; border-radius: 8px;">
                    <h4 style="margin-bottom: 1rem;">ğŸ”— ç”¢å“ç›¸ä¼¼åº¦çŸ©é™£</h4><div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;"><thead><tr>
                    <th style="padding: 0.5rem; background: white; border: 1px solid #E5E5EA;"></th>
                    ${products.map((p, i) => `<th style="padding: 0.5rem; background: white; border: 1px solid #E5E5EA; font-size: 0.8rem;">${p.model.substring(0,10)} ${i + 1}</th>`).join('')}
                    </tr></thead><tbody>
                    ${products.map((p1, i) => `<tr>
                        <td style="padding: 0.5rem; background: white; border: 1px solid #E5E5EA; font-weight: 600; font-size: 0.8rem;">${p1.model.substring(0,10)} ${i + 1}</td>
                        ${products.map((p2, j) => {
                            const score = similarity[i][j];
                            const color = score > 0.8 ? '#30D158' : score > 0.6 ? '#FF9500' : score > 0.4 ? '#007AFF' : '#FF3B30';
                            return `<td style="padding: 0.5rem; background: white; border: 1px solid #E5E5EA; text-align: center; color: ${color}; font-weight: 600;">${(score * 100).toFixed(0)}%</td>`;
                        }).join('')}</tr>`).join('')}
                    </tbody></table></div>
                    <div style="margin-top: 1rem; font-size: 0.9rem; color: #666;"><p><strong>ç›¸ä¼¼åº¦èªªæ˜ï¼š</strong></p>
                    <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                        <li><span style="color: #30D158;">â—</span> 80%+ é«˜åº¦ç›¸ä¼¼</li><li><span style="color: #FF9500;">â—</span> 60-80% ä¸­åº¦ç›¸ä¼¼</li>
                        <li><span style="color: #007AFF;">â—</span> 40-60% ä½åº¦ç›¸ä¼¼</li><li><span style="color: #FF3B30;">â—</span> <40% å·®ç•°è¼ƒå¤§</li>
                    </ul></div></div>`;
            const specsTableElement = document.getElementById('specsComparisonTable');
            if (specsTableElement && specsTableElement.parentNode) { // Ensure parentNode exists
                 specsTableElement.insertAdjacentHTML('afterend', matrixHtml);
            }
        }
        
        function generateMockForecast() {
            if (filteredProducts.length === 0) return [];
            const currentAvg = filteredProducts.reduce((sum, p) => sum + p.price, 0) / filteredProducts.length;
            const forecast = [];
            for (let i = 0; i < 6; i++) {
                const trend = -0.02 * i; const seasonality = Math.sin((i + 1) * Math.PI / 6) * 0.05; const noise = (Math.random() - 0.5) * 0.1;
                forecast.push({
                    month: new Date(Date.now() + i * 30 * 24 * 60 * 60 * 1000).toLocaleDateString('zh-TW', { month: 'short' }),
                    price: Math.round(currentAvg * (1 + trend + seasonality + noise))
                });
            }
            return forecast;
        }

        function analyzePricePatterns() { // Corrected function name
            if (filteredProducts.length === 0) return [];
            const pricesBySource = {};
            filteredProducts.forEach(product => {
                if (!pricesBySource[product.source]) pricesBySource[product.source] = [];
                pricesBySource[product.source].push(product.price);
            });
            const patterns = [];
            for (const [source, prices] of Object.entries(pricesBySource)) {
                if (prices.length > 1) {
                    const avg = prices.reduce((a, b) => a + b, 0) / prices.length;
                    const variance = Math.sqrt(prices.reduce((sum, price) => sum + Math.pow(price - avg, 2), 0) / prices.length);
                    patterns.push({ source, avgPrice: Math.round(avg), variance: Math.round(variance), priceStability: variance < 5000 ? 'ç©©å®š' : variance < 10000 ? 'ä¸­ç­‰' : 'æ³¢å‹•å¤§' });
                }
            }
            return patterns;
        }

        function displayPricePatterns(patterns) {
            if (patterns.length === 0) {
                 document.getElementById('pricePatternResults').innerHTML = '<p>ç„¡åƒ¹æ ¼æ¨¡å¼å¯åˆ†æ</p>'; return;
            }
            const patternsHtml = patterns.map(p => `
                <div class="price-difference-item"><div><strong>${p.source}</strong><br><small>åƒ¹æ ¼ç©©å®šæ€§: ${p.priceStability}</small></div>
                <div style="text-align: right;"><div style="color: #007AFF; font-weight: 600;">å¹³å‡ ${p.avgPrice.toLocaleString()}</div><small style="color: #666;">è®Šç•° Â±${p.variance.toLocaleString()}</small></div></div>`).join('');
            document.getElementById('pricePatternResults').innerHTML = `<div style="margin-top: 1.5rem; background: #F8F9FA; padding: 1rem; border-radius: 8px;"><h4 style="margin-bottom: 1rem;">ğŸ“Š å„ä¾†æºåƒ¹æ ¼æ¨¡å¼</h4>${patternsHtml}</div>`;
            document.getElementById('pricePatternResults').style.display = 'block';
        }
        
        // === åœ–è¡¨æ¸²æŸ“åŠŸèƒ½ ===
        // Declare chart instances globally to manage them
        let priceComparisonChartInstance = null;
        let specsDistributionChartInstance = null;
        let performanceScoreChartInstance = null;
        let trendAnalysisChartInstance = null; // For the trends tab

        function renderPriceComparisonChart() {
            const ctx = document.getElementById('priceComparisonChart').getContext('2d');
            if (priceComparisonChartInstance) priceComparisonChartInstance.destroy();
            if (filteredProducts.length === 0) return;

            const groupedData = {};
            filteredProducts.forEach(product => {
                if (!groupedData[product.source]) groupedData[product.source] = [];
                groupedData[product.source].push(product);
            });
            const datasets = Object.entries(groupedData).map(([source, products], index) => {
                const colors = ['#007AFF', '#34C759', '#FF9500', '#FF3B30', '#5856D6', '#AF52DE', '#30D158'];
                return {
                    label: source,
                    data: products.map(p => ({ x: p.name.substring(0, 20) + (p.name.length > 20 ? '...' : ''), y: p.price })),
                    backgroundColor: colors[index % colors.length] + 'B3', // Added alpha for better visibility
                    borderColor: colors[index % colors.length], borderWidth: 1
                };
            });
            priceComparisonChartInstance = new Chart(ctx, {
                type: 'bar', data: { datasets },
                options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'å„ä¾†æºåƒ¹æ ¼æ¯”è¼ƒ', font: { size: 16, weight: 'bold' } }, legend: { display: true, position: 'top' } }, scales: { x: { title: { display: true, text: 'ç”¢å“å‹è™Ÿ' } }, y: { title: { display: true, text: 'åƒ¹æ ¼ (TWD)' }, ticks: { callback: value => '$' + value.toLocaleString() } } } }
            });
        }

        function renderSpecsDistributionChart() {
            const ctx = document.getElementById('specsDistributionChart').getContext('2d');
            if (specsDistributionChartInstance) specsDistributionChartInstance.destroy();
            if (filteredProducts.length === 0) return;
            const memoryDist = getDistribution(filteredProducts, 'memory');
            specsDistributionChartInstance = new Chart(ctx, {
                type: 'doughnut', data: { labels: Object.keys(memoryDist), datasets: [{ data: Object.values(memoryDist), backgroundColor: ['#007AFF', '#34C759', '#FF9500', '#FF3B30', '#5856D6', '#AF52DE'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'è¨˜æ†¶é«”é…ç½®åˆ†å¸ƒ', font: { size: 14, weight: 'bold' } }, legend: { position: 'bottom' } } }
            });
        }

        function renderPerformanceScoreChart() {
            const ctx = document.getElementById('performanceScoreChart').getContext('2d');
            if (performanceScoreChartInstance) performanceScoreChartInstance.destroy();
            const uniqueProducts = getUniqueProductsByModel();
            if (uniqueProducts.length === 0) return;
            const scores = uniqueProducts.map(p => calculateValueScore(p));
            performanceScoreChartInstance = new Chart(ctx, {
                type: 'radar', data: { labels: uniqueProducts.map(p => p.model.substring(0,15)), datasets: [{ label: 'æ€§èƒ½è©•åˆ†', data: scores, backgroundColor: 'rgba(0, 122, 255, 0.2)', borderColor: '#007AFF', borderWidth: 2, pointBackgroundColor: '#007AFF' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'ç”¢å“æ€§èƒ½è©•åˆ†å°æ¯”', font: { size: 14, weight: 'bold' } }, legend: { display: false } }, scales: { r: { beginAtZero: true, suggestedMax: Math.max(...scores, 0) * 1.2 || 5 } } } // Added suggestedMax fallback
            });
        }
        
        function renderTrendAnalysisChart(forecastData = null) { // For the trends tab
            const ctx = document.getElementById('trendAnalysisChart').getContext('2d');
            if (trendAnalysisChartInstance) trendAnalysisChartInstance.destroy();
            if (filteredProducts.length === 0 && !forecastData) return;

            if (forecastData) { // If forecast data is provided, show line chart
                trendAnalysisChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: { labels: forecastData.map(d => d.month), datasets: [{ label: 'é æ¸¬åƒ¹æ ¼', data: forecastData.map(d => d.price), backgroundColor: 'rgba(88, 86, 214, 0.1)', borderColor: '#5856D6', borderWidth: 3, fill: true, tension: 0.4 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'æœªä¾† 6 å€‹æœˆåƒ¹æ ¼è¶¨å‹¢é æ¸¬', font: { size: 16, weight: 'bold' } } }, scales: { y: { title: { display: true, text: 'é æ¸¬åƒ¹æ ¼ (TWD)' }, ticks: { callback: value => '$' + value.toLocaleString() } } } }
                });
            } else { // Default to price distribution bar chart if no forecast data
                renderPriceDistributionChart(); // Call the specific doughnut chart function
            }
        }

        function renderPriceDistributionChart() { // Specific function for doughnut chart on trends tab
            const ctx = document.getElementById('trendAnalysisChart').getContext('2d');
            if (trendAnalysisChartInstance) trendAnalysisChartInstance.destroy(); // Use the same instance variable
            if (filteredProducts.length === 0) return;

            const priceRanges = [ { label: '< 20K', min: 0, max: 20000, color: '#30D158' }, { label: '20K-40K', min: 20000, max: 40000, color: '#34C759' }, { label: '40K-60K', min: 40000, max: 60000, color: '#007AFF' }, { label: '60K-80K', min: 60000, max: 80000, color: '#FF9500' }, { label: '80K+', min: 80000, max: Infinity, color: '#FF3B30' }];
            const rangeCounts = priceRanges.map(range => filteredProducts.filter(p => p.price >= range.min && p.price < range.max).length);

            trendAnalysisChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: priceRanges.map(r => r.label), datasets: [{ data: rangeCounts, backgroundColor: priceRanges.map(r => r.color), borderWidth: 2, borderColor: '#fff' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'åƒ¹æ ¼å€é–“åˆ†å¸ƒ', font: { size: 16, weight: 'bold' } }, legend: { position: 'bottom' } } }
            });
        }


        // === æ•¸æ“šåº«ç®¡ç†åŠŸèƒ½ (Persistence) ===
        function saveToDatabase(product) {
            const key = product.dbKey || `${product.name}_${product.source}_${product.price}`; // Ensure dbKey exists or is generated
            productDatabase.set(key, { ...product, dbKey: key, savedAt: new Date(), lastUpdated: new Date(product.lastUpdated || Date.now()) });
        }

        function loadFromDatabase() {
            try {
                const saved = JSON.parse(localStorage.getItem('macPriceDatabase') || '[]');
                productDatabase.clear();
                saved.forEach(product => {
                    product.lastUpdated = new Date(product.lastUpdated); // Ensure it's a Date object
                    productDatabase.set(product.dbKey, product);
                });
                syncDatabaseToProducts();
            } catch (error) { console.error('è¼‰å…¥æ•¸æ“šåº«å¤±æ•—:', error); }
        }

        function syncDatabaseToProducts() {
            allProducts = Array.from(productDatabase.values());
            // filteredProducts = [...allProducts]; // applyFilters will handle this
        }

        function persistDatabase() {
            try {
                const data = Array.from(productDatabase.values());
                localStorage.setItem('macPriceDatabase', JSON.stringify(data));
            } catch (error) { console.error('æŒä¹…åŒ–æ•¸æ“šåº«å¤±æ•—:', error); }
        }

        // === å‰ªè²¼ç°¿ç›£æ§åŠŸèƒ½ ===
        let clipboardMonitorActive = false;
        let clipboardMonitorInterval;

        function initClipboardMonitor() { /* Placeholder, actual permission request might be needed */ }

        async function toggleClipboardMonitor() {
            if (clipboardMonitorActive) stopClipboardMonitor();
            else await startClipboardMonitor();
        }

        async function startClipboardMonitor() {
            try {
                if (!navigator.clipboard || !navigator.clipboard.readText) throw new Error('ç€è¦½å™¨ä¸æ”¯æ´å‰ªè²¼ç°¿ API');
                await navigator.permissions.query({ name: "clipboard-read" }); // Request permission implicitly

                clipboardMonitorActive = true;
                document.getElementById('clipboardBtn').innerHTML = '<span>â¸ï¸</span> åœæ­¢ç›£æ§';
                document.getElementById('clipboardStatus').style.background = '#30D158';
                document.getElementById('clipboardText').textContent = 'ç›£æ§ä¸­...';

                clipboardMonitorInterval = setInterval(async () => {
                    try {
                        const text = await navigator.clipboard.readText();
                        if (text !== lastClipboardCheck && text.length > 10) {
                            lastClipboardCheck = text; await processClipboardContent(text);
                        }
                    } catch (err) { /* console.warn('ç„¡æ³•è®€å–å‰ªè²¼ç°¿:', err.name, err.message); */ } // Be less noisy
                }, 2000);
            } catch (error) { alert('ç„¡æ³•å•Ÿå‹•å‰ªè²¼ç°¿ç›£æ§: ' + error.message); stopClipboardMonitor(); }
        }

        function stopClipboardMonitor() {
            clipboardMonitorActive = false;
            if (clipboardMonitorInterval) clearInterval(clipboardMonitorInterval);
            document.getElementById('clipboardBtn').innerHTML = '<span>ğŸ‘ï¸</span> å•Ÿå‹•å‰ªè²¼ç°¿ç›£æ§';
            document.getElementById('clipboardStatus').style.background = '#FF3B30';
            document.getElementById('clipboardText').textContent = 'ç›£æ§å·²åœæ­¢';
            document.getElementById('clipboardUrls').style.display = 'none';
        }

        async function processClipboardContent(content) {
            const urls = extractUrlsFromText(content);
            if (urls.length > 0) {
                displayDetectedUrls(urls);
                for (const url of urls) {
                    if (!clipboardUrls.has(url)) { clipboardUrls.add(url); await processUrlFromClipboard(url); }
                }
            } else if (containsProductInfo(content)) { await processTextFromClipboard(content); }
        }

        function extractUrlsFromText(text) {
            const urlPattern = /https?:\/\/[^\s]+/g;
            const matches = text.match(urlPattern) || [];
            return matches.filter(url => ['apple.com', 'pchome', 'momo', 'shopee', 'yahoo', 'ruten', 'mac', 'imac'].some(keyword => url.includes(keyword)));
        }
        function containsProductInfo(text) { return /mac|imac|macbook|apple|m[123]\s|è¨˜æ†¶é«”|å„²å­˜|åƒ¹æ ¼|NT\$|\$[0-9]/i.test(text) && text.length > 50; }
        function displayDetectedUrls(urls) {
            const urlContainer = document.getElementById('clipboardUrls');
            const urlList = document.getElementById('urlList');
            urlContainer.style.display = 'block';
            urlList.innerHTML = urls.map(url => `<div style="padding: 0.2rem 0; border-bottom: 1px solid #E5E5EA;"><a href="${url}" target="_blank" style="color: #007AFF; text-decoration: none; font-size: 0.8rem;">${url.length > 60 ? url.substring(0, 60) + '...' : url}</a></div>`).join('');
        }
        async function processUrlFromClipboard(url) {
            showParseStatus(`æª¢æ¸¬åˆ°æ–°ç¶²å€ï¼Œæ­£åœ¨è™•ç†: ${url.substring(0,50)}...`);
            try {
                const product = generateProductFromUrl(url);
                await enrichProductInfo(product);
                saveToDatabase(product); persistDatabase(); syncDatabaseToProducts(); applyFilters();
            } catch (error) { console.error('è™•ç†å‰ªè²¼ç°¿ URL å¤±æ•—:', error); }
            // hideParseStatus(); // Hide status after each URL or after all?
        }
        async function processTextFromClipboard(text) {
            showParseStatus('æª¢æ¸¬åˆ°ç”¢å“æè¿°æ–‡æœ¬ï¼Œæ­£åœ¨è§£æ...');
            try {
                const product = await extractProductFromText(text, 'clipboard', Date.now());
                if (product) {
                    await enrichProductInfo(product);
                    saveToDatabase(product); persistDatabase(); syncDatabaseToProducts(); applyFilters();
                }
            } catch (error) { console.error('è™•ç†å‰ªè²¼ç°¿æ–‡æœ¬å¤±æ•—:', error); }
            // hideParseStatus();
        }

        // === æ™ºèƒ½è£œè¶³ç”¢å“ä¿¡æ¯ ===
        async function enrichProductInfo(product) {
            if (isProductInfoComplete(product)) return product;
            showParseStatus(`æ­£åœ¨æœå°‹ ${product.name.substring(0,30)}... çš„è©³ç´°è¦æ ¼...`);
            try {
                const enrichedInfo = await mockSearchProductInfo(product);
                Object.assign(product, enrichedInfo);
            } catch (error) { console.error('è£œè¶³ç”¢å“ä¿¡æ¯å¤±æ•—:', error); }
        }
        function isProductInfoComplete(product) { return ['processor', 'memory', 'storage', 'screen'].every(f => product[f] && product[f] !== 'Unknown' && product[f] !== 'è«‹ç¢ºèª'); }
        async function mockSearchProductInfo(product) {
            return new Promise(resolve => setTimeout(() => resolve({
                description: `${product.name} çš„è©³ç´°è¦æ ¼ä¿¡æ¯`, gpu: detectGPU(product.name), cpu: product.processor,
                displayTech: detectDisplayTech(product.name), connectivity: 'Wi-Fi 6E, Bluetooth 5.3',
                ports: detectPorts(product.name), weight: detectWeight(product.name), battery: detectBattery(product.name)
            }), 1000));
        }
        function detectGPU(name) { if (name.includes('M3 Ultra')) return '76-æ ¸å¿ƒ GPU'; if (name.includes('M3 Max')) return '40-æ ¸å¿ƒ GPU'; if (name.includes('M3 Pro')) return '18-æ ¸å¿ƒ GPU'; if (name.includes('M3')) return '10-æ ¸å¿ƒ GPU'; if (name.includes('M2')) return '8-æ ¸å¿ƒ GPU'; return 'æ•´åˆå¼ GPU'; }
        function detectDisplayTech(name) { if (name.includes('Pro')) return 'Liquid Retina XDR'; if (name.includes('iMac')) return '4.5K Retina'; return 'Liquid Retina'; }
        function detectPorts(name) { if (name.includes('Pro')) return 'Thunderbolt 4 x3, HDMI, SDXC'; if (name.includes('Air')) return 'Thunderbolt 4 x2, 3.5mm'; if (name.includes('mini')) return 'Thunderbolt 4 x2, USB-A x2, HDMI'; return 'Thunderbolt 4'; }
        function detectWeight(name) { if (name.includes('16')) return '2.16 kg'; if (name.includes('14')) return '1.55 kg'; if (name.includes('Air')) return '1.24 kg'; return 'è«‹ç¢ºèª'; }
        function detectBattery(name) { if (name.includes('Pro 16')) return 'é«˜é” 22 å°æ™‚'; if (name.includes('Pro 14')) return 'é«˜é” 18 å°æ™‚'; if (name.includes('Air')) return 'é«˜é” 18 å°æ™‚'; return 'è«‹ç¢ºèª'; }

        // è™•ç†æ–‡ä»¶ä¸Šå‚³
        async function handleFileUpload(event) {
            const files = Array.from(event.target.files); // Allow multiple files
            if (!files.length) return;

            const fileNames = files.map(f => f.name).join(', ');
            document.getElementById('fileName').textContent = `å·²é¸æ“‡ ${files.length} å€‹æ–‡ä»¶: ${fileNames}`;
            showParseStatus(`æ­£åœ¨è™•ç† ${files.length} å€‹æ–‡ä»¶...`);
            let totalProductsAdded = 0;

            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    updateParseProgress((i / files.length) * 100, `æ­£åœ¨è§£ææ–‡ä»¶: ${file.name}`);
                    
                    let content;
                    const fileType = file.name.split('.').pop().toLowerCase();
                    content = await readFileContent(file); // Use existing readFileContent

                    let productsFromFile = [];
                    if (fileType === 'csv') {
                        productsFromFile = await parseCSVContent(content, file.name);
                    } else {
                        productsFromFile = await parseTextContent(content, fileType, file.name);
                    }
                    
                    productsFromFile.forEach(product => {
                        if(product) { // Ensure product is not null
                           saveToDatabase(product);
                           totalProductsAdded++;
                        }
                    });
                }
                persistDatabase();
                syncDatabaseToProducts();
                applyFilters();
                hideParseStatus();
                alert(`æˆåŠŸè§£æ ${files.length} å€‹æ–‡ä»¶ï¼æ–°å¢äº† ${totalProductsAdded} å€‹å•†å“ã€‚`);
                document.getElementById('fileUpload').value = ''; // Reset file input
                document.getElementById('fileName').textContent = 'æ”¯æ´å¤šæª”æ¡ˆä¸Šå‚³ï¼šHTMLã€Markdownã€TXTã€CSV';


            } catch (error) {
                console.error('æ–‡ä»¶è§£æéŒ¯èª¤:', error);
                alert('æ–‡ä»¶è§£æå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ–‡ä»¶æ ¼å¼ã€‚');
                hideParseStatus();
            }
        }
        
        // è™•ç†è²¼ä¸Šå…§å®¹
        async function handlePasteContent() {
            try {
                const text = await navigator.clipboard.readText();
                if (!text) {
                    alert('å‰ªè²¼ç°¿ç‚ºç©ºã€‚');
                    return;
                }
                showParseStatus('æ­£åœ¨è§£æè²¼ä¸Šçš„å…§å®¹...');
                updateParseProgress(50, 'åˆ†ææ–‡æœ¬çµæ§‹...');
                const product = await extractProductFromText(text, 'è²¼ä¸Šçš„å…§å®¹', Date.now());
                if (product) {
                    await enrichProductInfo(product);
                    saveToDatabase(product);
                    persistDatabase();
                    syncDatabaseToProducts();
                    applyFilters();
                    alert('æˆåŠŸå¾è²¼ä¸Šçš„å…§å®¹è§£æå•†å“ï¼');
                } else {
                    alert('æœªèƒ½å¾è²¼ä¸Šçš„å…§å®¹è§£æå‡ºæœ‰æ•ˆå•†å“è³‡è¨Šã€‚');
                }
                hideParseStatus();
            } catch (error) {
                console.error('è²¼ä¸Šå…§å®¹è§£æéŒ¯èª¤:', error);
                alert('è®€å–å‰ªè²¼ç°¿å¤±æ•—æˆ–è§£æéŒ¯èª¤ã€‚');
                hideParseStatus();
            }
        }


        // è§£æ CSV å…§å®¹
        async function parseCSVContent(content, source) { // Returns array of products
            return new Promise((resolve) => {
                Papa.parse(content, {
                    header: true, dynamicTyping: true, skipEmptyLines: true,
                    delimitersToGuess: [',', '\t', '|', ';'],
                    complete: function(results) {
                        const products = results.data.map((row, index) => 
                            extractProductFromCSVRow(row, source, Date.now() + index) // Pass unique ID
                        ).filter(product => product !== null);
                        resolve(products); // Resolve with the array of products
                    }
                });
            });
        }


        // å¾ CSV è¡Œæå–å•†å“ä¿¡æ¯
        function extractProductFromCSVRow(row, source, id) { // Added id parameter
            const cleanRow = {};
            Object.keys(row).forEach(key => { cleanRow[key.trim()] = row[key]; });
            try {
                const nameField = findField(cleanRow, ['name', 'title', 'åç¨±', 'æ¨™é¡Œ', 'å•†å“åç¨±', 'product']);
                const priceField = findField(cleanRow, ['price', 'åƒ¹æ ¼', 'cost', 'amount', 'é‡‘é¡']);
                if (!nameField || !priceField || !cleanRow[nameField] || !cleanRow[priceField]) return null;

                const price = extractPrice(String(cleanRow[priceField]));
                if (price === null) return null;
                
                const name = String(cleanRow[nameField]).trim();

                return {
                    id: id, name: name,
                    model: detectModel(name || cleanRow[findField(cleanRow, ['model', 'å‹è™Ÿ'])] || ''),
                    processor: detectProcessor(name || cleanRow[findField(cleanRow, ['processor', 'cpu'])] || ''),
                    memory: extractMemory(cleanRow[findField(cleanRow, ['memory', 'ram'])] || name || ''),
                    storage: extractStorage(cleanRow[findField(cleanRow, ['storage', 'ssd'])] || name || ''),
                    screen: extractScreen(name || cleanRow[findField(cleanRow, ['screen', 'display'])] || ''),
                    condition: detectCondition(name || cleanRow[findField(cleanRow, ['condition', 'ç‹€æ³'])] || ''),
                    price: price, originalPrice: extractPrice(String(cleanRow[findField(cleanRow, ['originalPrice', 'åŸåƒ¹'])])) || price,
                    source: source, url: String(cleanRow[findField(cleanRow, ['url', 'link'])] || '#'),
                    availability: String(cleanRow[findField(cleanRow, ['availability', 'åº«å­˜'])] || 'è«‹ç¢ºèª'),
                    warranty: String(cleanRow[findField(cleanRow, ['warranty', 'ä¿å›º'])] || 'è«‹ç¢ºèª'),
                    lastUpdated: new Date()
                };
            } catch (error) { console.error('CSV è¡Œè§£æéŒ¯èª¤:', error, row); return null; }
        }

        // è§£ææ–‡æœ¬å…§å®¹ (HTML/MD/TXT)
        async function parseTextContent(content, fileType, source) { // Returns array of products
            let cleanContent = content;
            if (fileType === 'html') {
                cleanContent = cleanContent.replace(/<script[\s\S]*?<\/script>/gi, '');
                cleanContent = cleanContent.replace(/<style[\s\S]*?<\/style>/gi, '');
                cleanContent = cleanContent.replace(/<[^>]*>/g, ' ');
            }
            if (fileType === 'md') {
                cleanContent = cleanContent.replace(/```[\s\S]*?```/g, '');
                cleanContent = cleanContent.replace(/`[^`]*`/g, '');
                cleanContent = cleanContent.replace(/[#*_\[\]()]/g, ' ');
            }
            const paragraphs = cleanContent.split(/\n\s*\n|\r\n\s*\r\n/).filter(p => p.trim().length > 20); // Min length for a paragraph
            const products = [];
            for (let i = 0; i < paragraphs.length; i++) {
                updateParseProgress((i / paragraphs.length) * 100, `è§£ææ®µè½ ${i + 1}/${paragraphs.length}`);
                const product = await extractProductFromText(paragraphs[i], source, Date.now() + i + Math.random()); // Pass unique ID
                if (product) products.push(product);
                if (i % 10 === 0) await new Promise(resolve => setTimeout(resolve, 5)); // Avoid blocking
            }
            return products; // Return the array of products
        }


        // å¾æ–‡æœ¬æ®µè½æå–å•†å“ä¿¡æ¯
        async function extractProductFromText(text, source, id) { // Added id parameter
            const macKeywords = /mac|imac|macbook|mac mini|mac studio|apple/i;
            if (!macKeywords.test(text)) return null;

            const price = extractPrice(text);
            if (price === null) return null;

            const nameMatch = text.match(/^[^\n\r]*(?:mac|imac|macbook)[^\n\r]*/i) || 
                             text.match(/(?:mac|imac|macbook)[^\n\r]*/i);
            if (!nameMatch) return null;
            const name = nameMatch[0].trim().substring(0, 100);

            return {
                id: id, name: name, model: detectModel(name), processor: detectProcessor(text),
                memory: extractMemory(text), storage: extractStorage(text), screen: extractScreen(text),
                condition: detectCondition(text), price: price, originalPrice: price, source: source,
                url: extractUrl(text) || '#', availability: 'è«‹ç¢ºèª', warranty: 'è«‹ç¢ºèª', lastUpdated: new Date()
            };
        }

        // === æ™ºèƒ½æå–å‡½æ•¸ ===
        function findField(obj, keywords) {
            const keys = Object.keys(obj);
            for (const keyword of keywords) {
                const found = keys.find(key => key.toLowerCase().includes(keyword.toLowerCase()) || keyword.toLowerCase().includes(key.toLowerCase()));
                if (found && obj[found] !== null && obj[found] !== undefined) return found; // Check for null/undefined
            }
            // Fallback: if no keyword matches, try to find a key that is not explicitly empty or null
            for (const key of keys) {
                if (obj[key] !== null && obj[key] !== undefined && String(obj[key]).trim() !== '') return key;
            }
            return keys[0]; // Last resort
        }
        function extractPrice(text) {
            if (typeof text !== 'string' && typeof text !== 'number') return null;
            const sText = String(text);
            const patterns = [ /\$\s*([0-9,]+)/, /NT\$\s*([0-9,]+)/, /([0-9,]+)\s*å…ƒ/, /price[:\s]+([0-9,]+)/i, /([0-9,]+)\s*TWD/i, /([0-9]{4,})/ ]; // Min 4 digits for generic number
            for (const pattern of patterns) {
                const match = sText.match(pattern);
                if (match && match[1]) {
                    const number = parseInt(match[1].replace(/[^\d]/g, ''));
                    if (number >= 1000 && number <= 500000) return number;
                }
            }
            return null;
        }
        function detectModel(text) { if (!text) return 'Mac'; text = String(text).toLowerCase(); if (text.includes('macbook air')) return 'MacBook Air'; if (text.includes('macbook pro')) return 'MacBook Pro'; if (text.includes('imac')) return 'iMac'; if (text.includes('mac mini')) return 'Mac mini'; if (text.includes('mac studio')) return 'Mac Studio'; if (text.includes('macbook')) return 'MacBook'; return 'Mac'; }
        function detectProcessor(text) { if (!text) return 'Unknown'; text = String(text); const ps = ['M3 Ultra', 'M3 Max', 'M3 Pro', 'M3', 'M2 Ultra', 'M2 Max', 'M2 Pro', 'M2', 'M1 Ultra', 'M1 Max', 'M1 Pro', 'M1']; for (const p of ps) if (text.toLowerCase().includes(p.toLowerCase())) return `Apple ${p}`; if (text.includes('Intel')) return 'Intel'; return 'Apple Silicon'; }
        function extractMemory(text) { if (!text) return '8GB'; text = String(text); const m = text.match(/(\d+)\s*GB/i); if (m && m[1]) { const s = parseInt(m[1]); if (s >= 4 && s <= 128) return `${s}GB`; } return '8GB'; }
        function extractStorage(text) { if (!text) return '256GB'; text = String(text); const m = text.match(/(\d+)\s*(GB|TB)/i); if (m && m[1] && m[2]) { const s = parseInt(m[1]); const u = m[2].toUpperCase(); if (u === 'TB' && s >= 1 && s <= 8) return `${s}TB`; if (u === 'GB' && s >= 128 && s <= 8192) return `${s}GB`; } return '256GB'; }
        function extractScreen(text) { if (!text) return '13.3å‹'; text = String(text); const m = text.match(/(\d+(?:\.\d+)?)\s*(?:å‹|inch|")/i); if (m && m[1]) return `${m[1]}å‹`; if (text.includes('Air')) return '13.6å‹'; if (text.includes('Pro') && text.includes('14')) return '14.2å‹'; if (text.includes('Pro') && text.includes('16')) return '16.2å‹'; if (text.includes('iMac')) return '24å‹'; if (text.includes('mini')) return 'ç„¡'; return '13.3å‹'; }
        function detectCondition(text) { if (!text) return 'new'; text = String(text).toLowerCase(); if (text.includes('æ•´æ–°') || text.includes('refurbished')) return 'refurbished'; if (text.includes('äºŒæ‰‹') || text.includes('used')) { if (text.includes('aç´š') || text.includes('grade a')) return 'used-a'; if (text.includes('bç´š') || text.includes('grade b')) return 'used-b'; if (text.includes('cç´š') || text.includes('grade c')) return 'used-c'; return 'used-a'; } if (text.includes('æ•™è‚²') || text.includes('å­¸ç”Ÿ') || text.includes('student')) return 'student'; return 'new'; }
        function extractUrl(text) { const m = String(text).match(/https?:\/\/[^\s'"]+/); return m ? m[0] : null; }

        // === æ‰¹é‡è™•ç†åŠŸèƒ½ ===
        async function processBulkUrls() { // Made async
            const urls = document.getElementById('bulkUrls').value.split('\n').map(url => url.trim()).filter(url => url && url.startsWith('http'));
            if (urls.length === 0) { alert('è«‹è¼¸å…¥è‡³å°‘ä¸€å€‹æœ‰æ•ˆçš„ URL'); return; }
            showParseStatus(`æº–å‚™è™•ç† ${urls.length} å€‹ç¶²å€`);
            let productsAddedCount = 0;
            for (let i = 0; i < urls.length; i++) {
                updateParseProgress((i / urls.length) * 100, `è™•ç†ç¶²å€ ${i + 1}/${urls.length}: ${urls[i].substring(0,50)}...`);
                try {
                    const product = generateProductFromUrl(urls[i]);
                    await enrichProductInfo(product); // Enrich before saving
                    saveToDatabase(product);
                    productsAddedCount++;
                    await new Promise(resolve => setTimeout(resolve, 200)); // Shorter delay
                } catch (error) { console.error(`è™•ç† URL å¤±æ•—: ${urls[i]}`, error); }
            }
            persistDatabase(); syncDatabaseToProducts(); applyFilters(); hideParseStatus();
            document.getElementById('bulkUrls').value = '';
            alert(`æ‰¹é‡è™•ç†å®Œæˆï¼æˆåŠŸæ–°å¢ ${productsAddedCount} å€‹å•†å“ã€‚`);
        }

        function clearAllData() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å•†å“æ•¸æ“šå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ¢å¾©ã€‚')) {
                productDatabase.clear(); // Clear the map
                localStorage.removeItem('macPriceDatabase'); // Clear local storage
                allProducts = []; filteredProducts = []; parseResults = [];
                applyFilters(); // This will re-render everything based on empty data
                alert('æ‰€æœ‰æ•¸æ“šå·²æ¸…ç©ºã€‚');
            }
        }

        // === é€²åº¦é¡¯ç¤ºåŠŸèƒ½ ===
        function showParseStatus(message) { document.getElementById('parseStatus').style.display = 'block'; document.getElementById('parseDetails').textContent = message; document.getElementById('progressBar').style.width = '0%'; }
        function updateParseProgress(percentage, message) { document.getElementById('progressBar').style.width = `${percentage}%`; document.getElementById('parseDetails').textContent = message; }
        function hideParseStatus() { setTimeout(() => { document.getElementById('parseStatus').style.display = 'none'; }, 1000); }
        
        function copyPromptToClipboard() {
            if (currentPrompt) {
                navigator.clipboard.writeText(currentPrompt)
                    .then(() => alert('Prompt å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼'))
                    .catch(err => alert('è¤‡è£½å¤±æ•—: ' + err));
            }
        }

        // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
